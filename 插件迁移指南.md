# DOWæ’ä»¶è¿ç§»åˆ°XXXPADæ’ä»¶æŒ‡å—

æœ¬æ–‡æ¡£æ€»ç»“äº†ä»DOWé¡¹ç›®æ’ä»¶è¿ç§»åˆ°XXXPADé¡¹ç›®çš„å…³é”®ç‚¹å’Œæœ€ä½³å®è·µï¼Œä»¥ä¾¿å¼€å‘è€…åœ¨è¿ç§»å…¶ä»–æ’ä»¶æ—¶å‚è€ƒã€‚

## 1. æ’ä»¶ç»“æ„å·®å¼‚

### 1.1 ç›®å½•ç»“æ„

- DOWæ’ä»¶é€šå¸¸ä½äº`plugins/dowplugins/æ’ä»¶å/æ’ä»¶å.py`
- XXXPADæ’ä»¶é€šå¸¸ä½äº`plugins/æ’ä»¶å/main.py`

### 1.2 ç±»ç»“æ„

- DOWæ’ä»¶é€šå¸¸ç»§æ‰¿è‡ªç‰¹å®šçš„åŸºç±»
- XXXPADæ’ä»¶å¯èƒ½æœ‰ä¸åŒçš„åŸºç±»å’Œåˆå§‹åŒ–æ–¹æ³•
- éœ€è¦è°ƒæ•´æ„é€ å‡½æ•°å’Œæ–¹æ³•ç­¾åä»¥é€‚åº”æ–°çš„æ¡†æ¶

## 2. è¡¨æƒ…ç¬¦å·å’Œæ ¼å¼å¤„ç†

### 2.1 ä¿æŒä¸€è‡´çš„è¡¨æƒ…ç¬¦å·

åœ¨è¿ç§»Apilotæ’ä»¶æ—¶ï¼Œæˆ‘ä»¬å‘ç°è¡¨æƒ…ç¬¦å·çš„ä½¿ç”¨éœ€è¦ä¿æŒä¸€è‡´ã€‚å»ºè®®ï¼š

- å‚è€ƒåŸç‰ˆæ’ä»¶çš„è¡¨æƒ…ç¬¦å·ï¼Œä¸è¦è‡ªè¡Œåˆ›å»ºæ–°çš„è¡¨æƒ…ç¬¦å·ç³»ç»Ÿ
- ç¡®ä¿æ‰€æœ‰ç›¸ä¼¼åŠŸèƒ½ä½¿ç”¨ç›¸åŒçš„è¡¨æƒ…ç¬¦å·
- ä½¿ç”¨æ›´ç°ä»£å’Œæ¸…æ™°çš„è¡¨æƒ…ç¬¦å·æ¥æé«˜å¯è¯»æ€§

### 2.2 çŠ¶æ€æŒ‡ç¤ºå™¨

å¯¹äºæ˜¾ç¤ºçŠ¶æ€çš„åœºæ™¯ï¼ˆå¦‚å¤©æ°”æŒ‡æ•°ï¼‰ï¼Œä½¿ç”¨å½©è‰²åœ†ç‚¹è¡¨æƒ…ç¬¦å·æ¥è¡¨ç¤ºä¸åŒçŠ¶æ€ï¼š

```python
# æ ¹æ®æŒ‡æ ‡ç±»å‹é€‰æ‹©ç‰¹å®šçš„åˆ¤æ–­é€»è¾‘ - ä¸¥æ ¼æŒ‰ç…§åŸç‰ˆå®ç°
if indicator_type == "ziwanxian":  # ç´«å¤–çº¿æŒ‡æ•°
    if any(keyword in level for keyword in ["å¼±", "æœ€å¼±"]):
        status_emoji = "ğŸŸ¢"  # ç»¿è‰²è¡¨ç¤ºå¼±
    elif "ä¸­ç­‰" in level:
        status_emoji = "ğŸŸ¡"  # é»„è‰²è¡¨ç¤ºä¸­ç­‰
    elif "å¼º" in level and "å¾ˆå¼º" not in level and "æå¼º" not in level:
        status_emoji = "ğŸŸ "  # æ©™è‰²è¡¨ç¤ºå¼º
    elif "å¾ˆå¼º" in level:
        status_emoji = "ğŸ”´"  # çº¢è‰²è¡¨ç¤ºå¾ˆå¼º
    elif "æå¼º" in level:
        status_emoji = "ğŸŸ£"  # ç´«è‰²è¡¨ç¤ºæå¼º
elif indicator_type == "ganmao":  # æ„Ÿå†’æŒ‡æ•°
    if "ä¸æ˜“å‘" in level:
        status_emoji = "ğŸŸ¢"  # ç»¿è‰²è¡¨ç¤ºä¸æ˜“å‘
    elif "å°‘å‘" in level:
        status_emoji = "ğŸ”µ"  # è“è‰²è¡¨ç¤ºå°‘å‘
    elif "è¾ƒæ˜“å‘" in level:
        status_emoji = "ğŸŸ¡"  # é»„è‰²è¡¨ç¤ºè¾ƒæ˜“å‘
    elif "æ˜“å‘" in level:
        status_emoji = "ğŸ”´"  # çº¢è‰²è¡¨ç¤ºæ˜“å‘
elif indicator_type == "xiche":  # æ´—è½¦æŒ‡æ•°
    if "é€‚å®œ" in level and "ä¸" not in level and "è¾ƒ" not in level:
        status_emoji = "ğŸŸ¢"  # ç»¿è‰²è¡¨ç¤ºé€‚å®œ
    elif "è¾ƒé€‚å®œ" in level:
        status_emoji = "ğŸ”µ"  # è“è‰²è¡¨ç¤ºè¾ƒé€‚å®œ
    elif "ä¸é€‚å®œ" in level:
        status_emoji = "ğŸ”´"  # çº¢è‰²è¡¨ç¤ºä¸é€‚å®œ
# ... å…¶ä»–æŒ‡æ ‡ç±»å‹çš„åˆ¤æ–­é€»è¾‘
else:  # é€šç”¨åˆ¤æ–­é€»è¾‘
    if any(keyword in level for keyword in ["é€‚å®œ", "è‰¯å¥½", "æœ€å¼±", "ä¸éœ€è¦", "ä¸æ˜“", "èˆ’é€‚"]):
        status_emoji = "ğŸŸ¢"  # ç»¿è‰²è¡¨ç¤ºè‰¯å¥½
    elif any(keyword in level for keyword in ["è¾ƒé€‚å®œ", "ä¸­ç­‰", "å¼±", "åé«˜", "ä¸€èˆ¬"]):
        status_emoji = "ğŸŸ¡"  # é»„è‰²è¡¨ç¤ºä¸­ç­‰
    elif any(keyword in level for keyword in ["è¾ƒä¸å®œ", "è¾ƒå¼º", "å°‘é‡"]):
        status_emoji = "ğŸŸ "  # æ©™è‰²è¡¨ç¤ºè¾ƒå·®
    elif any(keyword in level for keyword in ["ä¸å®œ", "å¾ˆå¼º", "ä¸å»ºè®®", "é«˜å‘", "æ˜“å‘", "æå¼º", "ä¸é€‚å®œ"]):
        status_emoji = "ğŸ”´"  # çº¢è‰²è¡¨ç¤ºä¸ä½³
```

### 2.3 æ ¼å¼ç»Ÿä¸€

ç¡®ä¿è¾“å‡ºæ ¼å¼åœ¨ä¸åŒæŸ¥è¯¢ç±»å‹é—´ä¿æŒä¸€è‡´ï¼š

- å½“å¤©å¤©æ°”ã€æ˜å¤©å¤©æ°”ã€åå¤©å¤©æ°”åº”ä½¿ç”¨ç›¸ä¼¼çš„æ ¼å¼
- ä¿æŒæ ‡é¢˜ã€åˆ†éš”ç¬¦å’Œæ•°æ®å±•ç¤ºçš„ä¸€è‡´æ€§
- ä½¿ç”¨ç›¸åŒçš„é»˜è®¤å€¼å’Œé”™è¯¯æç¤º

## 3. é”™è¯¯å¤„ç†å’Œé»˜è®¤å€¼

### 3.1 å¤„ç†Noneå€¼

APIè¿”å›çš„æ•°æ®å¯èƒ½åŒ…å«Noneå€¼ï¼Œéœ€è¦å¦¥å–„å¤„ç†ï¼š

```python
# å¤„ç†Noneå€¼çš„ç¤ºä¾‹
weather = data.get('weather', 'æœªçŸ¥')
if weather is None or weather == "None":
    weather = 'æœªçŸ¥'
```

### 3.2 æ•°æ®éªŒè¯

åœ¨ä½¿ç”¨æ•°æ®å‰è¿›è¡ŒéªŒè¯ï¼Œç¡®ä¿æ•°æ®æœ‰æ•ˆï¼š

```python
# åªæœ‰å½“åç§°å’Œçº§åˆ«éƒ½æœ‰å€¼æ—¶æ‰æ·»åŠ åˆ°ç»“æœä¸­
if name and name != 'æœªçŸ¥æŒ‡æ•°':
    # å¤„ç†æ•°æ®...
```

### 3.3 æ¡ä»¶æ˜¾ç¤º

æ ¹æ®æ•°æ®çš„å¯ç”¨æ€§æœ‰æ¡ä»¶åœ°æ˜¾ç¤ºä¿¡æ¯ï¼š

```python
result = f"ğŸ™ï¸ åŸå¸‚: {city}"
if province and province != city:
    result += f" ({province})"
```

## 4. æ•°æ®å¤„ç†é€»è¾‘

### 4.1 æ•°æ®æå–å’Œè½¬æ¢

ç¡®ä¿æ­£ç¡®æå–å’Œè½¬æ¢APIè¿”å›çš„æ•°æ®ï¼š

```python
# æ—¶é—´å¤„ç†ç¤ºä¾‹
time_parts = time_str.split(' ')
time = time_parts[1] if len(time_parts) > 1 else time_str
```

### 4.2 æ•°æ®åˆ†ç»„å’Œæ’åº

æ ¹æ®éœ€è¦å¯¹æ•°æ®è¿›è¡Œåˆ†ç»„å’Œæ’åºï¼š

```python
# é™åˆ¶æ˜¾ç¤ºæ•°é‡ç¤ºä¾‹
count = 0
for hour in hour_data:
    if count >= 10:  # åªæ˜¾ç¤º10å°æ—¶
        break
    # å¤„ç†æ•°æ®...
    count += 1
```

## 5. ç‰¹å®šåŠŸèƒ½è¿ç§»

### 5.1 å¤©æ°”æŸ¥è¯¢åŠŸèƒ½

å¤©æ°”æŸ¥è¯¢åŠŸèƒ½éœ€è¦ç‰¹åˆ«æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š

- ç¡®ä¿æ­£ç¡®å¤„ç†ä¸åŒçš„æŸ¥è¯¢ç±»å‹ï¼ˆå½“å¤©ã€æ˜å¤©ã€åå¤©ã€ä¸ƒå¤©ï¼‰
- ä¸ºæ¯ç§æŸ¥è¯¢ç±»å‹æä¾›é€‚å½“çš„æ ¼å¼å’Œè¯¦ç»†ç¨‹åº¦
- å¤„ç†ç‰¹æ®Šå¤©æ°”æ¡ä»¶å’ŒæŒ‡æ•°
- æ˜¾ç¤ºå¤©æ°”é¢„è­¦ä¿¡æ¯ï¼ˆéå¸¸é‡è¦ï¼‰

```python
# æ·»åŠ é¢„è­¦ä¿¡æ¯ç¤ºä¾‹ - ä¸¥æ ¼æŒ‰ç…§åŸç‰ˆæ ¼å¼
alarm_data = data.get('alarm', [])
if isinstance(alarm_data, list) and alarm_data:
    # æ·»åŠ ç©ºè¡Œåˆ†éš”
    result += "\nâš ï¸ é¢„è­¦ä¿¡æ¯:\n"
    for alarm in alarm_data:
        if isinstance(alarm, dict):
            # æ ¹æ®é¢„è­¦ç­‰çº§é€‰æ‹©åˆé€‚çš„emoji
            level_emoji = "âš ï¸"
            level = alarm.get('level', '')
            if "çº¢è‰²" in level:
                level_emoji = "ğŸ”´"
            elif "æ©™è‰²" in level:
                level_emoji = "ğŸŸ "
            elif "é»„è‰²" in level:
                level_emoji = "ğŸŸ¡"
            elif "è“è‰²" in level:
                level_emoji = "ğŸ”µ"

            # å¤„ç†å†…å®¹ä¸­å¯èƒ½å­˜åœ¨çš„HTMLæ ‡ç­¾
            tips = alarm.get('tips', '').replace('<br>', '\n        ').replace('<br/>', '\n        ')

            # æ„å»ºæ›´æ¸…æ™°çš„é¢„è­¦ä¿¡æ¯æ ¼å¼
            result += (
                f"{level_emoji} {alarm.get('type', '')}{level}é¢„è­¦: {alarm.get('title', '')}\n"
                f"â° å‘å¸ƒæ—¶é—´: {alarm.get('publish_time', '')}\n"
                f"ğŸ“‹ é¢„è­¦æç¤º:\n"
                f"        {tips}\n"
                f"ğŸ“¢ è¯¦ç»†å†…å®¹:\n"
                f"        {alarm.get('content', '')}\n\n"
            )
```

### 5.2 ç”Ÿæ´»æŒ‡æ•°å¤„ç†

ç”Ÿæ´»æŒ‡æ•°ï¼ˆå¦‚æ´—è½¦æŒ‡æ•°ã€è¿åŠ¨æŒ‡æ•°ç­‰ï¼‰éœ€è¦ï¼š

- ä½¿ç”¨é€‚å½“çš„è¡¨æƒ…ç¬¦å·
- æ·»åŠ çŠ¶æ€é¢œè‰²æŒ‡ç¤ºå™¨
- æä¾›æ¸…æ™°çš„æè¿°

## 6. å›¾ç‰‡å’Œè§†é¢‘å‘é€

### 6.1 å›¾ç‰‡å‘é€

åœ¨xxxbotä¸­ï¼Œæœ‰å¤šç§æ–¹å¼å¯ä»¥å‘é€å›¾ç‰‡ç»™ç”¨æˆ·ï¼Œä¸‹é¢è¯¦ç»†ä»‹ç»å„ç§æ–¹æ³•åŠå…¶é€‚ç”¨åœºæ™¯ã€‚

#### 6.1.1 å‘é€å›¾ç‰‡çš„æ–¹å¼

xxxbotæä¾›äº†ä»¥ä¸‹å‡ ç§å‘é€å›¾ç‰‡çš„æ–¹å¼ï¼š

1. **ç›´æ¥ä½¿ç”¨WechatAPIå®¢æˆ·ç«¯æ–¹æ³•**ï¼š
   ```python
   await bot.send_image_message(wxid, image)
   ```

2. **ä½¿ç”¨Replyç±»ï¼ˆæœ€å¸¸ç”¨æ–¹å¼ï¼‰**ï¼š
   ```python
   # å‘é€æœ¬åœ°å›¾ç‰‡æ–‡ä»¶
   with open(image_path, "rb") as image_file:
       image_reply = Reply(ReplyType.IMAGE, image_file)
       e_context["channel"].send(image_reply, e_context["context"])

   # å‘é€å›¾ç‰‡URL
   image_url = "https://example.com/image.jpg"
   e_context["channel"].send(Reply(ReplyType.IMAGE_URL, image_url), e_context["context"])
   ```

3. **è¾…åŠ©æ–¹æ³•**ï¼š
   ```python
   # å‘é€æœ¬åœ°å›¾ç‰‡çš„è¾…åŠ©æ–¹æ³•
   def _send_local_image(self, image_path, e_context):
       """å‘é€æœ¬åœ°å›¾ç‰‡"""
       try:
           with open(image_path, 'rb') as f:
               image_reply = Reply(ReplyType.IMAGE, f)
               e_context["channel"].send(image_reply, e_context["context"])
       except Exception as e:
           logger.error(f"å‘é€æœ¬åœ°å›¾ç‰‡å¤±è´¥: {e}")
   ```

#### 6.1.2 WechatAPIå®¢æˆ·ç«¯æ–¹æ³•

##### æ–¹æ³•è¯´æ˜

XXXPAD æä¾›äº† `send_image_message()` æ–¹æ³•ç”¨äºå‘é€å›¾ç‰‡ï¼Œè¯¥æ–¹æ³•å¯ä»¥æ¥å—å›¾ç‰‡å­—èŠ‚æ•°æ®ã€å›¾ç‰‡æ–‡ä»¶è·¯å¾„æˆ–å›¾ç‰‡ URLã€‚

```python
async def send_image_message(self, to_wxid, image)
```

##### å‚æ•°è¯´æ˜

- `to_wxid`: æ¥æ”¶è€…çš„å¾®ä¿¡ ID
- `image`: å›¾ç‰‡å†…å®¹ï¼Œå¯ä»¥æ˜¯ä»¥ä¸‹ç±»å‹ï¼š
  - å›¾ç‰‡çš„äºŒè¿›åˆ¶æ•°æ®ï¼ˆbytesï¼‰
  - å›¾ç‰‡çš„ URLï¼ˆå­—ç¬¦ä¸²ï¼‰
  - å›¾ç‰‡çš„æ–‡ä»¶è·¯å¾„ï¼ˆå­—ç¬¦ä¸²æˆ–PathLikeå¯¹è±¡ï¼‰
  - å›¾ç‰‡çš„base64ç¼–ç å­—ç¬¦ä¸²

##### ç¤ºä¾‹ä»£ç 

```python
# å‘é€å›¾ç‰‡å­—èŠ‚æ•°æ®
async def send_image_bytes(bot, to_wxid, image_bytes):
    await bot.send_image_message(to_wxid, image_bytes)

# å‘é€å›¾ç‰‡ URL
async def send_image_url(bot, to_wxid, image_url):
    await bot.send_image_message(to_wxid, image_url)

# å‘é€å›¾ç‰‡æ–‡ä»¶è·¯å¾„
async def send_image_path(bot, to_wxid, image_path):
    await bot.send_image_message(to_wxid, image_path)
```

#### 6.1.3 Replyç±»æ–¹å¼ï¼ˆæ¨èï¼‰

##### æ–¹æ³•è¯´æ˜

ä½¿ç”¨Replyç±»å’ŒReplyTypeæšä¸¾æ˜¯æ’ä»¶å¼€å‘ä¸­æœ€é€šç”¨çš„æ–¹å¼ï¼Œä¸å…·ä½“çš„é€šé“å®ç°è§£è€¦ï¼Œå¯ä»¥é€‚ç”¨äºä¸åŒçš„æ¸ é“ï¼ˆå¾®ä¿¡ã€ç»ˆç«¯ç­‰ï¼‰ã€‚

```python
# å¯¼å…¥å¿…è¦çš„ç±»
from bridge.reply import Reply, ReplyType

# å‘é€å›¾ç‰‡
e_context["channel"].send(reply, e_context["context"])
```

##### ReplyTypeç±»å‹

ä¸å›¾ç‰‡ç›¸å…³çš„ReplyTypeæœ‰ï¼š
- `ReplyType.IMAGE`: ç”¨äºå‘é€å›¾ç‰‡æ–‡ä»¶ï¼ˆéœ€è¦æä¾›æ–‡ä»¶å¯¹è±¡ï¼‰
- `ReplyType.IMAGE_URL`: ç”¨äºå‘é€å›¾ç‰‡URLï¼ˆéœ€è¦æä¾›URLå­—ç¬¦ä¸²ï¼‰

##### ç¤ºä¾‹ä»£ç 

```python
# å‘é€æœ¬åœ°å›¾ç‰‡æ–‡ä»¶
with open(image_path, "rb") as image_file:
    image_reply = Reply(ReplyType.IMAGE, image_file)
    e_context["channel"].send(image_reply, e_context["context"])

# å‘é€å›¾ç‰‡URL
image_url = "https://example.com/image.jpg"
e_context["channel"].send(Reply(ReplyType.IMAGE_URL, image_url), e_context["context"])

# å‘é€å†…å­˜ä¸­çš„å›¾ç‰‡æ•°æ®
from io import BytesIO
image_buffer = BytesIO(image_data)
e_context["channel"].send(Reply(ReplyType.IMAGE, image_buffer), e_context["context"])
```

#### 6.1.4 å›¾ç‰‡ä¸‹è½½ç¤ºä¾‹

```python
# ä½¿ç”¨å¼‚æ­¥ HTTP å®¢æˆ·ç«¯ä¸‹è½½å›¾ç‰‡
async def download_image(url):
    headers = {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
        'Accept': 'image/webp, image/apng, image/*',
        'Referer': 'https://api.example.com/'  # æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹
    }

    async with aiohttp.ClientSession() as session:
        async with session.get(url, headers=headers, timeout=15) as response:
            if response.status == 200:
                # æ£€æŸ¥æ˜¯å¦æ˜¯å›¾ç‰‡å†…å®¹
                content_type = response.headers.get('Content-Type', '')
                if 'image' in content_type:
                    image_data = await response.read()
                    return image_data
                else:
                    return url  # å¦‚æœä¸æ˜¯å›¾ç‰‡ï¼Œè¿”å› URL
            else:
                return url  # å¦‚æœä¸‹è½½å¤±è´¥ï¼Œè¿”å› URL
```

#### 6.1.5 å›¾ç‰‡ä¸Šä¼ æ–¹æ³•

åœ¨xxxbotä¸­ï¼Œå›¾ç‰‡å‘é€é€šå¸¸éœ€è¦å…ˆä¸Šä¼ å›¾ç‰‡ï¼Œç„¶åå†å‘é€ã€‚ä»¥ä¸‹æ˜¯å›¾ç‰‡ä¸Šä¼ çš„æ–¹æ³•ï¼š

#### 6.1.5.1 WechatAPIå®¢æˆ·ç«¯æ–¹æ³•

```python
# ä¸Šä¼ å›¾ç‰‡
response = await bot._send_image_message(wxid, image)
```

è¿™ä¸ªæ–¹æ³•ä¼šè‡ªåŠ¨å¤„ç†å›¾ç‰‡çš„ä¸Šä¼ å’Œå‘é€ï¼Œè¿”å›çš„å“åº”ä¸­åŒ…å«ä¸Šä¼ æˆåŠŸçš„ä¿¡æ¯ã€‚

#### 6.1.5.2 ä½¿ç”¨ç¬¬ä¸‰æ–¹æœåŠ¡ä¸Šä¼ å›¾ç‰‡

æŸäº›æ’ä»¶å¯èƒ½éœ€è¦å°†å›¾ç‰‡ä¸Šä¼ åˆ°ç¬¬ä¸‰æ–¹æœåŠ¡ï¼Œä»¥ä¸‹æ˜¯ä¸€ä¸ªé€šç”¨çš„å›¾ç‰‡ä¸Šä¼ ç¤ºä¾‹ï¼š

```python
async def upload_image(self, image_path, headers=None):
    """ä¸Šä¼ å›¾ç‰‡åˆ°æœåŠ¡å™¨
    Args:
        image_path: å›¾ç‰‡è·¯å¾„
        headers: è¯·æ±‚å¤´
    Returns:
        dict: ä¸Šä¼ ç»“æœ
    """
    try:
        # è¯»å–å›¾ç‰‡æ•°æ®
        with open(image_path, 'rb') as f:
            image_data = f.read()

        # è®¡ç®—æ–‡ä»¶å¤§å°å’ŒMD5
        file_size = len(image_data)
        file_md5 = hashlib.md5(image_data).hexdigest()

        # æ„å»ºä¸Šä¼ è¯·æ±‚
        url = "https://api.example.com/upload"

        # å‡†å¤‡æ–‡ä»¶æ•°æ®
        files = {
            "file": (os.path.basename(image_path), image_data, "image/jpeg")
        }

        # å‘é€è¯·æ±‚
        async with aiohttp.ClientSession() as session:
            async with session.post(url, headers=headers, data=files) as response:
                if response.status == 200:
                    result = await response.json()
                    return result
                else:
                    logger.error(f"ä¸Šä¼ å›¾ç‰‡å¤±è´¥: HTTP {response.status}")
                    return None
    except Exception as e:
        logger.error(f"ä¸Šä¼ å›¾ç‰‡å¼‚å¸¸: {str(e)}")
        return None
```

#### 6.1.5.3 ä½¿ç”¨OSSç­‰äº‘å­˜å‚¨æœåŠ¡ä¸Šä¼ å›¾ç‰‡

å¯¹äºéœ€è¦ä½¿ç”¨é˜¿é‡Œäº‘OSSç­‰äº‘å­˜å‚¨æœåŠ¡çš„æ’ä»¶ï¼Œä»¥ä¸‹æ˜¯ä¸€ä¸ªä¸Šä¼ ç¤ºä¾‹ï¼š

```python
def upload_image_to_oss(self, image_path, policy_info):
    """ä¸Šä¼ å›¾ç‰‡åˆ°OSS
    Args:
        image_path: å›¾ç‰‡è·¯å¾„
        policy_info: OSSç­–ç•¥ä¿¡æ¯
    Returns:
        str: ä¸Šä¼ åçš„å›¾ç‰‡URL
    """
    try:
        # ä¸Šä¼ å›¾ç‰‡åˆ°OSS
        files = {
            'OSSAccessKeyId': (None, policy_info['accessId']),
            'policy': (None, policy_info['policy']),
            'signature': (None, policy_info['signature']),
            'key': (None, policy_info['key']),
            'dir': (None, policy_info['dir']),
            'success_action_status': (None, '200'),
            'file': (os.path.basename(image_path), open(image_path, 'rb'), 'image/jpeg')
        }

        upload_res = requests.post(policy_info['host'], files=files)
        if upload_res.status_code != 200:
            raise Exception("ä¸Šä¼ å›¾ç‰‡å¤±è´¥")

        # è¿”å›å›¾ç‰‡URL
        return f"{policy_info['host']}/{policy_info['key']}"
    except Exception as e:
        logger.error(f"ä¸Šä¼ å›¾ç‰‡åˆ°OSSå¤±è´¥: {str(e)}")
        return None
```

### 6.1.6 å›¾ç‰‡å¤„ç†æ³¨æ„äº‹é¡¹

1. **å›¾ç‰‡æ ¼å¼éªŒè¯**ï¼šå‘é€å‰ç¡®ä¿å›¾ç‰‡æ•°æ®æ˜¯æœ‰æ•ˆçš„PNGæˆ–JPEGæ ¼å¼
   ```python
   if image_data[:8].hex().startswith('89504e47') or image_data[:3].hex().startswith('ffd8ff'):
       logger.info("è¯»å–çš„å›¾ç‰‡æ•°æ®æ˜¯æœ‰æ•ˆçš„PNGæˆ–JPEGæ ¼å¼")
   ```

2. **å›¾ç‰‡å¤§å°å¤„ç†**ï¼šæŸäº›æƒ…å†µä¸‹å¯èƒ½éœ€è¦å‹ç¼©å›¾ç‰‡
   ```python
   # ä¿å­˜ä¸ºJPEGå¹¶ä¼˜åŒ–
   from PIL import Image
   import io

   # æ‰“å¼€å›¾ç‰‡
   img = Image.open(BytesIO(image_data))

   # è°ƒæ•´å¤§å°ï¼ˆå¦‚æœéœ€è¦ï¼‰
   if img.width > 1024 or img.height > 1024:
       img.thumbnail((1024, 1024))

   # ä¿å­˜ä¸ºä¼˜åŒ–çš„JPEG
   output = io.BytesIO()
   img.save(output, format='JPEG', quality=95, optimize=True)
   output.seek(0)
   image_content = output.getvalue()
   ```

3. **åçˆ¬æœºåˆ¶å¤„ç†**ï¼šè®¸å¤šå›¾ç‰‡ API æœ‰åçˆ¬æœºåˆ¶ï¼Œéœ€è¦è®¾ç½®é€‚å½“çš„ HTTP è¯·æ±‚å¤´ï¼Œç‰¹åˆ«æ˜¯ `User-Agent` å’Œ `Referer`ã€‚

4. **å¼‚æ­¥å¤„ç†**ï¼šä½¿ç”¨ `aiohttp` è€Œä¸æ˜¯ `requests` è¿›è¡Œå¼‚æ­¥ HTTP è¯·æ±‚ï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹ã€‚

5. **é”™è¯¯å¤„ç†**ï¼šå›¾ç‰‡å‘é€å¯èƒ½å¤±è´¥ï¼Œåº”è¯¥æœ‰é€‚å½“çš„é”™è¯¯å¤„ç†å’Œå›é€€ç­–ç•¥ã€‚
   ```python
   try:
       # å‘é€å›¾ç‰‡ä»£ç 
       with open(image_path, "rb") as image_file:
           image_reply = Reply(ReplyType.IMAGE, image_file)
           e_context["channel"].send(image_reply, e_context["context"])
   except Exception as e:
       logger.error(f"å‘é€å›¾ç‰‡å¤±è´¥: {str(e)}")
       # å‘é€å¤±è´¥é€šçŸ¥ç»™ç”¨æˆ·
       e_context["channel"].send(Reply(ReplyType.TEXT, "å›¾ç‰‡å‘é€å¤±è´¥ï¼Œè¯·ç¨åå†è¯•"), e_context["context"])
   ```

6. **å†…å®¹ç±»å‹æ£€æŸ¥**ï¼šæ£€æŸ¥å“åº”çš„ `Content-Type` ç¡®ä¿æ˜¯å›¾ç‰‡å†…å®¹ã€‚

7. **å¤šå›¾å‘é€**ï¼šå‘é€å¤šå¼ å›¾ç‰‡æ—¶ï¼Œå¯èƒ½éœ€è¦æ·»åŠ å»¶è¿Ÿ
   ```python
   for image_url in image_urls:
       e_context["channel"].send(Reply(ReplyType.IMAGE_URL, image_url), e_context["context"])
       # æ·»åŠ å»¶è¿Ÿï¼Œé¿å…é¢‘ç¹å‘é€
       await asyncio.sleep(1)
   ```

### 6.2 è§†é¢‘å‘é€

åœ¨xxxbotä¸­ï¼Œæœ‰å¤šç§æ–¹å¼å¯ä»¥å‘é€è§†é¢‘ç»™ç”¨æˆ·ï¼Œä¸‹é¢è¯¦ç»†ä»‹ç»å„ç§æ–¹æ³•åŠå…¶é€‚ç”¨åœºæ™¯ã€‚

#### 6.2.1 å‘é€è§†é¢‘çš„æ–¹å¼

xxxbotæä¾›äº†ä»¥ä¸‹å‡ ç§å‘é€è§†é¢‘çš„æ–¹å¼ï¼š

1. **ç›´æ¥ä½¿ç”¨WechatAPIå®¢æˆ·ç«¯æ–¹æ³•**ï¼š
   ```python
   await bot.send_video_message(wxid, video, image=None)
   ```

2. **ä½¿ç”¨Replyç±»**ï¼š
   ```python
   # å‘é€æœ¬åœ°è§†é¢‘æ–‡ä»¶
   with open(video_path, "rb") as video_file:
       video_reply = Reply(ReplyType.VIDEO, video_file)
       e_context["channel"].send(video_reply, e_context["context"])

   # å‘é€è§†é¢‘URL
   video_url = "https://example.com/video.mp4"
   e_context["channel"].send(Reply(ReplyType.VIDEO_URL, video_url), e_context["context"])
   ```

#### 6.2.2 WechatAPIå®¢æˆ·ç«¯æ–¹æ³•

##### æ–¹æ³•è¯´æ˜

XXXPAD æä¾›äº† `send_video_message()` æ–¹æ³•ç”¨äºå‘é€è§†é¢‘ï¼Œè¯¥æ–¹æ³•å¯ä»¥æ¥å—è§†é¢‘å­—èŠ‚æ•°æ®ã€è§†é¢‘æ–‡ä»¶è·¯å¾„æˆ–è§†é¢‘ URLï¼Œè¿˜å¯ä»¥æ·»åŠ å°é¢å›¾ç‰‡ã€‚

```python
async def send_video_message(self, to_wxid, video, image=None, duration=None)
```

##### å‚æ•°è¯´æ˜

- `to_wxid`: æ¥æ”¶è€…çš„å¾®ä¿¡ ID
- `video`: è§†é¢‘å†…å®¹ï¼Œå¯ä»¥æ˜¯ä»¥ä¸‹ç±»å‹ï¼š
  - è§†é¢‘çš„äºŒè¿›åˆ¶æ•°æ®ï¼ˆbytesï¼‰
  - è§†é¢‘çš„ URLï¼ˆå­—ç¬¦ä¸²ï¼‰
  - è§†é¢‘çš„æ–‡ä»¶è·¯å¾„ï¼ˆå­—ç¬¦ä¸²æˆ–PathLikeå¯¹è±¡ï¼‰
  - è§†é¢‘çš„base64ç¼–ç å­—ç¬¦ä¸²
- `image`: å¯é€‰å‚æ•°ï¼Œè§†é¢‘å°é¢å›¾ç‰‡ï¼Œå¯ä»¥æ˜¯ä»¥ä¸‹ç±»å‹ï¼š
  - å›¾ç‰‡çš„äºŒè¿›åˆ¶æ•°æ®ï¼ˆbytesï¼‰
  - å›¾ç‰‡çš„ URLï¼ˆå­—ç¬¦ä¸²ï¼‰
  - å›¾ç‰‡çš„æ–‡ä»¶è·¯å¾„ï¼ˆå­—ç¬¦ä¸²æˆ–PathLikeå¯¹è±¡ï¼‰
  - å›¾ç‰‡çš„base64ç¼–ç å­—ç¬¦ä¸²
  - å­—ç¬¦ä¸²"None"ï¼ˆå½“éœ€è¦æ˜ç¡®æŒ‡å®šä¸ä½¿ç”¨å°é¢æ—¶ï¼‰
  - å¦‚æœä¸æä¾›æˆ–ä¸ºNoneï¼Œåˆ™ä½¿ç”¨é»˜è®¤å°é¢
- `duration`: å¯é€‰å‚æ•°ï¼Œè§†é¢‘æ—¶é•¿ï¼ˆç§’ï¼‰ï¼Œå¦‚æœä¸æä¾›åˆ™å°è¯•ä»è§†é¢‘ä¸­æå–

##### ç¤ºä¾‹ä»£ç 

```python
# å‘é€ä¸å¸¦å°é¢çš„è§†é¢‘
async def send_video_without_cover(bot, to_wxid, video_data):
    await bot.send_video_message(to_wxid, video_data)

# å‘é€å¸¦å°é¢çš„è§†é¢‘
async def send_video_with_cover(bot, to_wxid, video_data, cover_data):
    await bot.send_video_message(to_wxid, video=video_data, image=cover_data)

# æ˜ç¡®æŒ‡å®šä¸ä½¿ç”¨å°é¢çš„è§†é¢‘
async def send_video_with_no_cover(bot, to_wxid, video_data):
    await bot.send_video_message(to_wxid, video=video_data, image="None")

# å‘é€è§†é¢‘æ–‡ä»¶è·¯å¾„
async def send_video_path(bot, to_wxid, video_path, cover_path=None):
    await bot.send_video_message(to_wxid, video=video_path, image=cover_path)
```

#### 6.2.3 Replyç±»æ–¹å¼

##### æ–¹æ³•è¯´æ˜

ä½¿ç”¨Replyç±»å’ŒReplyTypeæšä¸¾æ˜¯æ’ä»¶å¼€å‘ä¸­é€šç”¨çš„æ–¹å¼ï¼Œä¸å…·ä½“çš„é€šé“å®ç°è§£è€¦ï¼Œå¯ä»¥é€‚ç”¨äºä¸åŒçš„æ¸ é“ã€‚

```python
# å¯¼å…¥å¿…è¦çš„ç±»
from bridge.reply import Reply, ReplyType

# å‘é€è§†é¢‘
e_context["channel"].send(reply, e_context["context"])
```

##### ReplyTypeç±»å‹

ä¸è§†é¢‘ç›¸å…³çš„ReplyTypeæœ‰ï¼š
- `ReplyType.VIDEO`: ç”¨äºå‘é€è§†é¢‘æ–‡ä»¶ï¼ˆéœ€è¦æä¾›æ–‡ä»¶å¯¹è±¡ï¼‰
- `ReplyType.VIDEO_URL`: ç”¨äºå‘é€è§†é¢‘URLï¼ˆéœ€è¦æä¾›URLå­—ç¬¦ä¸²ï¼‰

##### ç¤ºä¾‹ä»£ç 

```python
# å‘é€æœ¬åœ°è§†é¢‘æ–‡ä»¶
with open(video_path, "rb") as video_file:
    video_reply = Reply(ReplyType.VIDEO, video_file)
    e_context["channel"].send(video_reply, e_context["context"])

# å‘é€è§†é¢‘URL
video_url = "https://example.com/video.mp4"
e_context["channel"].send(Reply(ReplyType.VIDEO_URL, video_url), e_context["context"])

# å‘é€å†…å­˜ä¸­çš„è§†é¢‘æ•°æ®
from io import BytesIO
video_buffer = BytesIO(video_data)
e_context["channel"].send(Reply(ReplyType.VIDEO, video_buffer), e_context["context"])
```

##### æ³¨æ„äº‹é¡¹

ä½¿ç”¨Replyç±»å‘é€è§†é¢‘æ—¶ï¼Œæ— æ³•ç›´æ¥æŒ‡å®šè§†é¢‘å°é¢ã€‚å¦‚æœéœ€è¦æ§åˆ¶è§†é¢‘å°é¢ï¼Œå»ºè®®ä½¿ç”¨WechatAPIå®¢æˆ·ç«¯æ–¹æ³•ã€‚

#### 6.2.4 è§†é¢‘ä¸‹è½½å’Œå°é¢æå–ç¤ºä¾‹

##### åŒæ­¥æ–¹å¼æå–å°é¢

```python
# ä½¿ç”¨åŒæ­¥æ–¹å¼ä¸‹è½½è§†é¢‘å¹¶æå–å°é¢
def extract_thumbnail_from_video(video_path):
    """ä»è§†é¢‘ä¸­æå–ç¼©ç•¥å›¾"""
    try:
        # åˆ›å»ºä¸´æ—¶æ–‡ä»¶å¤¹
        thumbnail_dir = "temp_thumbnails"
        os.makedirs(thumbnail_dir, exist_ok=True)
        timestamp = int(time.time())
        thumbnail_path = os.path.join(thumbnail_dir, f"temp_thumbnail_{timestamp}.jpg")

        # æ‰§è¡Œffmpegå‘½ä»¤æå–ç¬¬ä¸€å¸§
        process = subprocess.run([
            "ffmpeg",
            "-i", video_path,
            "-ss", "00:00:01",  # ä»è§†é¢‘çš„ç¬¬1ç§’å¼€å§‹æå–
            "-vframes", "1",
            thumbnail_path,
            "-y"  # å¦‚æœæ–‡ä»¶å­˜åœ¨ï¼Œè¦†ç›–
        ], check=False, capture_output=True)

        if process.returncode == 0 and os.path.exists(thumbnail_path):
            with open(thumbnail_path, "rb") as image_file:
                image_data = image_file.read()
                # è½¬æ¢ä¸ºbase64ç¼–ç çš„å­—ç¬¦ä¸²
                cover_base64 = base64.b64encode(image_data).decode("utf-8")
                return cover_base64
        else:
            logger.error(f"ffmpegæ‰§è¡Œå¤±è´¥: {process.stderr.decode()}")
            return None
    except Exception as e:
        logger.error(f"æå–ç¼©ç•¥å›¾å¤±è´¥: {str(e)}")
        return None
    finally:
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        try:
            if 'thumbnail_path' in locals() and os.path.exists(thumbnail_path):
                os.remove(thumbnail_path)
            if os.path.exists(thumbnail_dir) and not os.listdir(thumbnail_dir):
                os.rmdir(thumbnail_dir)
        except Exception as e:
            logger.error(f"æ¸…ç†ä¸´æ—¶æ–‡ä»¶å¤±è´¥: {str(e)}")
```

##### å¼‚æ­¥æ–¹å¼æå–å°é¢

```python
# ä½¿ç”¨å¼‚æ­¥æ–¹å¼ä¸‹è½½è§†é¢‘å¹¶æå–å°é¢
async def extract_thumbnail_async(video_path):
    """å¼‚æ­¥ä»è§†é¢‘ä¸­æå–ç¼©ç•¥å›¾"""
    try:
        # åˆ›å»ºä¸´æ—¶æ–‡ä»¶å¤¹
        thumbnail_dir = "temp_thumbnails"
        os.makedirs(thumbnail_dir, exist_ok=True)
        timestamp = int(time.time())
        thumbnail_path = os.path.join(thumbnail_dir, f"temp_thumbnail_{timestamp}.jpg")

        # å¼‚æ­¥æ‰§è¡Œffmpegå‘½ä»¤
        process = await asyncio.create_subprocess_exec(
            "ffmpeg",
            "-i", video_path,
            "-ss", "00:00:01",  # ä»è§†é¢‘çš„ç¬¬1ç§’å¼€å§‹æå–
            "-vframes", "1",
            thumbnail_path,
            "-y",  # å¦‚æœæ–‡ä»¶å­˜åœ¨ï¼Œè¦†ç›–
            stdout=asyncio.subprocess.PIPE,
            stderr=asyncio.subprocess.PIPE
        )

        stdout, stderr = await process.communicate()

        if process.returncode == 0 and os.path.exists(thumbnail_path):
            with open(thumbnail_path, "rb") as image_file:
                image_data = image_file.read()
                # è½¬æ¢ä¸ºbase64ç¼–ç çš„å­—ç¬¦ä¸²
                cover_base64 = base64.b64encode(image_data).decode("utf-8")
                return cover_base64
        else:
            logger.error(f"ffmpegæ‰§è¡Œå¤±è´¥: {stderr.decode()}")
            return None
    except Exception as e:
        logger.error(f"æå–ç¼©ç•¥å›¾å¤±è´¥: {str(e)}")
        return None
    finally:
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        try:
            if 'thumbnail_path' in locals() and os.path.exists(thumbnail_path):
                os.remove(thumbnail_path)
            if os.path.exists(thumbnail_dir) and not os.listdir(thumbnail_dir):
                os.rmdir(thumbnail_dir)
        except Exception as e:
            logger.error(f"æ¸…ç†ä¸´æ—¶æ–‡ä»¶å¤±è´¥: {str(e)}")
```

##### å®Œæ•´çš„è§†é¢‘ä¸‹è½½å’Œå°é¢æå–ç¤ºä¾‹

```python
# ä¸‹è½½è§†é¢‘å¹¶æå–å°é¢
async def download_video_with_cover(url):
    headers = {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
        'Accept': 'video/mp4, video/*',
        'Referer': 'https://api.example.com/'  # æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹
    }

    try:
        # ä¸‹è½½è§†é¢‘
        async with aiohttp.ClientSession() as session:
            async with session.get(url, headers=headers, timeout=30) as response:
                if response.status == 200:
                    # æ£€æŸ¥æ˜¯å¦æ˜¯è§†é¢‘å†…å®¹
                    content_type = response.headers.get('Content-Type', '')
                    if 'video' in content_type or 'mp4' in content_type:
                        video_data = await response.read()

                        # åˆ›å»ºä¸´æ—¶æ–‡ä»¶ä¿å­˜è§†é¢‘
                        temp_dir = Path("temp")
                        temp_dir.mkdir(exist_ok=True)
                        timestamp = int(time.time())
                        video_path = temp_dir / f"video_{timestamp}.mp4"

                        with open(video_path, 'wb') as f:
                            f.write(video_data)

                        # æå–è§†é¢‘é¦–å¸§ä½œä¸ºå°é¢
                        cover_data = None
                        try:
                            # åˆ›å»ºä¸´æ—¶æ–‡ä»¶å¤¹
                            thumbnail_dir = Path("temp_thumbnails")
                            thumbnail_dir.mkdir(exist_ok=True)
                            thumbnail_path = thumbnail_dir / f"temp_thumbnail_{timestamp}.jpg"

                            # æ‰§è¡Œ ffmpeg å‘½ä»¤æå–ç¬¬ä¸€å¸§
                            process = subprocess.run([
                                "ffmpeg",
                                "-i", str(video_path),
                                "-ss", "00:00:01",  # ä»è§†é¢‘çš„ç¬¬ 1 ç§’å¼€å§‹æå–
                                "-vframes", "1",
                                str(thumbnail_path),
                                "-y"  # å¦‚æœæ–‡ä»¶å­˜åœ¨ï¼Œè¦†ç›–
                            ], check=False, capture_output=True)

                            if process.returncode == 0 and thumbnail_path.exists():
                                with open(thumbnail_path, "rb") as image_file:
                                    image_data = image_file.read()
                                    # è½¬æ¢ä¸ºbase64ç¼–ç çš„å­—ç¬¦ä¸²
                                    cover_data = base64.b64encode(image_data).decode("utf-8")
                            else:
                                cover_data = None
                        except Exception:
                            cover_data = None
                        finally:
                            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
                            try:
                                if 'thumbnail_path' in locals() and thumbnail_path.exists():
                                    thumbnail_path.unlink()
                                if thumbnail_dir.exists():
                                    thumbnail_dir.rmdir()
                            except Exception:
                                pass

                        # æ¸…ç†è§†é¢‘ä¸´æ—¶æ–‡ä»¶
                        try:
                            if video_path.exists():
                                video_path.unlink()
                        except Exception:
                            pass

                        # å°†è§†é¢‘æ•°æ®ä¹Ÿè½¬æ¢ä¸ºbase64ç¼–ç çš„å­—ç¬¦ä¸²
                        video_base64 = base64.b64encode(video_data).decode("utf-8")

                        # è¿”å›è§†é¢‘å’Œå°é¢çš„base64å­—ç¬¦ä¸²
                        return {"video": video_base64, "cover": cover_data}
                    else:
                        return url  # å¦‚æœä¸æ˜¯è§†é¢‘ï¼Œè¿”å› URL
                else:
                    return url  # å¦‚æœä¸‹è½½å¤±è´¥ï¼Œè¿”å› URL
    except Exception:
        return url  # å¦‚æœå‘ç”Ÿå¼‚å¸¸ï¼Œè¿”å› URL
```

#### 6.2.5 æ³¨æ„äº‹é¡¹

1. **è§†é¢‘å°é¢å¤„ç†**ï¼š
   - æ·»åŠ è§†é¢‘å°é¢å¯ä»¥æå‡ç”¨æˆ·ä½“éªŒï¼Œå»ºè®®å°½å¯èƒ½æä¾›å°é¢
   - å½“å°é¢æå–å¤±è´¥æ—¶ï¼Œä½¿ç”¨`image=cover_data or "None"`è€Œä¸æ˜¯`image=cover_data if cover_data else None`
   - å­—ç¬¦ä¸²"None"å’ŒPythonçš„Noneå€¼åœ¨APIä¸­æœ‰ä¸åŒçš„å¤„ç†æ–¹å¼
   - ä½¿ç”¨å­—ç¬¦ä¸²"None"å¯ä»¥ç¡®ä¿ä¸VideoSenderå’ŒVideoDemandæ’ä»¶çš„è¡Œä¸ºä¸€è‡´

2. **è§†é¢‘æ ¼å¼å’Œå¤§å°**ï¼š
   - å¾®ä¿¡æ”¯æŒçš„è§†é¢‘æ ¼å¼ä¸»è¦æ˜¯MP4ï¼Œå…¶ä»–æ ¼å¼å¯èƒ½éœ€è¦è½¬æ¢
   - è§†é¢‘å¤§å°æœ‰é™åˆ¶ï¼Œè¿‡å¤§çš„è§†é¢‘å¯èƒ½éœ€è¦å‹ç¼©
   - å‘é€APIæ–‡æ¡£ä¸­æåˆ°"ä¸Šä¼ é€Ÿåº¦å¾ˆæ…¢300KB/s"ï¼Œå¤§è§†é¢‘å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´
   - å¯¹äºå¤§è§†é¢‘ï¼Œå¯ä»¥è€ƒè™‘å‘é€é“¾æ¥å¡ç‰‡è€Œä¸æ˜¯ç›´æ¥å‘é€è§†é¢‘æ–‡ä»¶

3. **è§†é¢‘å‹ç¼©**ï¼š
   ```python
   # ä½¿ç”¨ffmpegå‹ç¼©è§†é¢‘ç¤ºä¾‹
   async def compress_video(input_path, output_path, target_size_mb=10):
       """å‹ç¼©è§†é¢‘åˆ°æŒ‡å®šå¤§å°"""
       try:
           # è·å–è§†é¢‘ä¿¡æ¯
           info_process = await asyncio.create_subprocess_exec(
               "ffmpeg", "-i", input_path,
               stdout=asyncio.subprocess.PIPE,
               stderr=asyncio.subprocess.PIPE
           )
           _, stderr = await info_process.communicate()

           # è®¡ç®—é€‚å½“çš„æ¯”ç‰¹ç‡
           # å‡è®¾1åˆ†é’Ÿè§†é¢‘çº¦60MBï¼Œæ ¹æ®ç›®æ ‡å¤§å°è°ƒæ•´æ¯”ç‰¹ç‡
           target_bitrate = f"{target_size_mb * 8 * 1024}k"

           # å‹ç¼©è§†é¢‘
           compress_process = await asyncio.create_subprocess_exec(
               "ffmpeg", "-i", input_path,
               "-b:v", target_bitrate,
               "-maxrate", target_bitrate,
               "-bufsize", f"{target_size_mb * 4 * 1024}k",
               "-c:v", "libx264",
               "-preset", "fast",
               "-c:a", "aac",
               "-b:a", "128k",
               output_path,
               "-y",
               stdout=asyncio.subprocess.PIPE,
               stderr=asyncio.subprocess.PIPE
           )

           stdout, stderr = await compress_process.communicate()

           if compress_process.returncode == 0:
               logger.info(f"è§†é¢‘å‹ç¼©æˆåŠŸ: {output_path}")
               return output_path
           else:
               logger.error(f"è§†é¢‘å‹ç¼©å¤±è´¥: {stderr.decode()}")
               return None
       except Exception as e:
           logger.error(f"è§†é¢‘å‹ç¼©å¼‚å¸¸: {str(e)}")
           return None
   ```

4. **ä¸´æ—¶æ–‡ä»¶å¤„ç†**ï¼šæå–è§†é¢‘å°é¢éœ€è¦ä½¿ç”¨ä¸´æ—¶æ–‡ä»¶ï¼Œè®°å¾—åŠæ—¶æ¸…ç†ã€‚

5. **ffmpeg ä¾èµ–**ï¼š
   - æå–è§†é¢‘å°é¢å’Œå‹ç¼©è§†é¢‘éœ€è¦ ffmpegï¼Œç¡®ä¿æœåŠ¡å™¨å·²å®‰è£…
   - åœ¨Windowsä¸Šï¼Œéœ€è¦å°†ffmpegæ·»åŠ åˆ°PATHç¯å¢ƒå˜é‡æˆ–æŒ‡å®šå®Œæ•´è·¯å¾„
   - åœ¨Linuxä¸Šï¼Œå¯ä»¥ä½¿ç”¨`apt-get install ffmpeg`æˆ–ç›¸åº”çš„åŒ…ç®¡ç†å™¨å®‰è£…

6. **è¶…æ—¶è®¾ç½®**ï¼šè§†é¢‘ä¸‹è½½å¯èƒ½éœ€è¦æ›´é•¿çš„è¶…æ—¶æ—¶é—´ï¼Œå»ºè®®è®¾ç½®ä¸º 30 ç§’æˆ–æ›´é•¿ã€‚

7. **é”™è¯¯å¤„ç†**ï¼šè§†é¢‘å¤„ç†æ¶‰åŠå¤šä¸ªæ­¥éª¤ï¼Œæ¯ä¸ªæ­¥éª¤éƒ½å¯èƒ½å¤±è´¥ï¼Œéœ€è¦å®Œå–„çš„é”™è¯¯å¤„ç†ã€‚

8. **HTTPå®¢æˆ·ç«¯é€‰æ‹©**ï¼š
   - ä½¿ç”¨`aiohttp`è€Œä¸æ˜¯`httpx`å¯èƒ½ä¼šæœ‰æ›´å¥½çš„å…¼å®¹æ€§
   - å¦‚æœä½¿ç”¨`httpx`ï¼Œç¡®ä¿æ­£ç¡®å¤„ç†é‡å®šå‘å’Œå“åº”çŠ¶æ€ç 

9. **å¼‚æ­¥å¤„ç†**ï¼š
   - è§†é¢‘å¤„ç†å¯èƒ½è€—æ—¶è¾ƒé•¿ï¼Œå»ºè®®ä½¿ç”¨å¼‚æ­¥æ–¹å¼é¿å…é˜»å¡ä¸»çº¿ç¨‹
   - å¯¹äºè€—æ—¶æ“ä½œï¼Œå¯ä»¥å…ˆå‘é€"å¤„ç†ä¸­"æ¶ˆæ¯ï¼Œç„¶ååœ¨å¤„ç†å®Œæˆåå‘é€ç»“æœ

## 7. æ–‡ä»¶ä¸Šä¼ å’Œå‘é€

### 7.1 æ–‡ä»¶å‘é€çš„æ–¹å¼

xxxbotæä¾›äº†ä»¥ä¸‹å‡ ç§å‘é€æ–‡ä»¶çš„æ–¹å¼ï¼š

1. **ç›´æ¥ä½¿ç”¨WechatAPIå®¢æˆ·ç«¯æ–¹æ³•**ï¼š
   ```python
   # ä¸Šä¼ æ–‡ä»¶å¹¶è·å–mediaId
   file_info = await bot.upload_file(file_data)

   # æ„é€ XMLæ¶ˆæ¯å¹¶å‘é€æ–‡ä»¶
   xml = f"""<appmsg appid="" sdkver="0">
       <title>{file_name}</title>
       <des></des>
       <action></action>
       <type>6</type>
       <showtype>0</showtype>
       <content></content>
       <url></url>
       <appattach>
           <totallen>{total_len}</totallen>
           <attachid>{media_id}</attachid>
           <fileext>{file_extension}</fileext>
       </appattach>
       <md5></md5>
   </appmsg>"""

   # å‘é€æ–‡ä»¶æ¶ˆæ¯
   await bot._send_cdn_file_msg(wxid, xml)
   ```

2. **ä½¿ç”¨Replyç±»**ï¼š
   ```python
   # å‘é€æœ¬åœ°æ–‡ä»¶
   with open(file_path, "rb") as file:
       file_reply = Reply(ReplyType.FILE, file)
       e_context["channel"].send(file_reply, e_context["context"])
   ```

### 7.2 æ–‡ä»¶ä¸Šä¼ æ–¹æ³•

#### 7.2.1 WechatAPIå®¢æˆ·ç«¯æ–¹æ³•

##### upload_fileæ–¹æ³•

```python
async def upload_file(self, file_data: Union[str, bytes, os.PathLike]) -> dict:
    """ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨ã€‚

    Args:
        file_data (Union[str, bytes, os.PathLike]): æ–‡ä»¶æ•°æ®ï¼Œæ”¯æŒbase64å­—ç¬¦ä¸²ï¼Œå­—èŠ‚æ•°æ®æˆ–æ–‡ä»¶è·¯å¾„

    Returns:
        dict: åŒ…å«ä¸Šä¼ æ–‡ä»¶ä¿¡æ¯çš„å­—å…¸ï¼ŒåŒ…æ‹¬mediaIdå’Œæ€»é•¿åº¦

    Raises:
        UserLoggedOut: æœªç™»å½•æ—¶è°ƒç”¨
        ValueError: æ–‡ä»¶æ•°æ®æ ¼å¼ä¸æ­£ç¡®
        æ ¹æ®error_handlerå¤„ç†é”™è¯¯
    """
```

##### è¿”å›å€¼ç¤ºä¾‹

```python
# ä¸Šä¼ æ–‡ä»¶è¿”å›çš„ä¿¡æ¯ç¤ºä¾‹
{
  'BaseResponse': {'ret': 0, 'errMsg': {}},
  'mediaId': '@cdn_3052020100044b30490201000204434d245e02033d14ba0204bc10949d020467fe1a3c042436396534353565362d323734302d346563372d383837342d3030376632616566313933390204052800050201000400c879beff_6c696f716d7776716c67717278647167_1',
  'clientAppDataId': 'wxid_uz9za1pqr3ea22_1744706107_UploadFile',
  'userName': 'wxid_uz9za1pqr3ea22',
  'totalLen': 52757,
  'startPos': 52757,
  'dataLen': 0,
  'createTime': 1744706108
}
```

### 7.3 æ–‡ä»¶å‘é€å®Œæ•´ç¤ºä¾‹

ä»¥ä¸‹æ˜¯ä¸€ä¸ªå®Œæ•´çš„æ–‡ä»¶å‘é€ç¤ºä¾‹ï¼ŒåŒ…æ‹¬æ–‡ä»¶è¯»å–ã€ä¸Šä¼ å’Œå‘é€ï¼š

```python
async def send_file_example(bot: WechatAPIClient, to_wxid: str, file_path: str):
    """å‘é€æ–‡ä»¶ç¤ºä¾‹"""
    try:
        # è¯»å–æ–‡ä»¶æ•°æ®
        with open(file_path, "rb") as f:
            file_data = f.read()

        # è·å–æ–‡ä»¶åå’Œæ‰©å±•å
        file_name = os.path.basename(file_path)
        file_extension = os.path.splitext(file_name)[1][1:]  # å»æ‰ç‚¹å·

        # ä¸Šä¼ æ–‡ä»¶
        logger.info(f"å¼€å§‹ä¸Šä¼ æ–‡ä»¶: {file_name}")
        file_info = await bot.upload_file(file_data)
        logger.info(f"æ–‡ä»¶ä¸Šä¼ æˆåŠŸ: {file_info}")

        # ä»æ–‡ä»¶ä¿¡æ¯ä¸­æå–å¿…è¦çš„å­—æ®µ
        media_id = file_info.get('mediaId')
        total_len = file_info.get('totalLen', len(file_data))

        # æ„é€ XMLæ¶ˆæ¯
        xml = f"""<appmsg appid="" sdkver="0">
    <title>{file_name}</title>
    <des></des>
    <action></action>
    <type>6</type>
    <showtype>0</showtype>
    <content></content>
    <url></url>
    <appattach>
        <totallen>{total_len}</totallen>
        <attachid>{media_id}</attachid>
        <fileext>{file_extension}</fileext>
    </appattach>
    <md5></md5>
</appmsg>"""

        # å‘é€æ–‡ä»¶æ¶ˆæ¯
        logger.info(f"å¼€å§‹å‘é€æ–‡ä»¶æ¶ˆæ¯: {file_name}")
        result = await bot._send_cdn_file_msg(to_wxid, xml)
        logger.info(f"æ–‡ä»¶æ¶ˆæ¯å‘é€ç»“æœ: {result}")

        return True
    except Exception as e:
        logger.error(f"å‘é€æ–‡ä»¶å¤±è´¥: {e}")
        return False
```

### 7.4 ä½¿ç”¨Replyç±»å‘é€æ–‡ä»¶

ä½¿ç”¨Replyç±»å‘é€æ–‡ä»¶æ˜¯æ’ä»¶å¼€å‘ä¸­æ›´å¸¸ç”¨çš„æ–¹å¼ï¼Œä¸å…·ä½“çš„é€šé“å®ç°è§£è€¦ï¼š

```python
# å¯¼å…¥å¿…è¦çš„ç±»
from bridge.reply import Reply, ReplyType

# å‘é€æœ¬åœ°æ–‡ä»¶
def send_file_with_reply(e_context, file_path):
    try:
        with open(file_path, "rb") as file:
            file_reply = Reply(ReplyType.FILE, file)
            e_context["channel"].send(file_reply, e_context["context"])
        return True
    except Exception as e:
        logger.error(f"å‘é€æ–‡ä»¶å¤±è´¥: {e}")
        return False
```

### 7.5 æ–‡ä»¶å‘é€æ³¨æ„äº‹é¡¹

1. **æ–‡ä»¶å¤§å°é™åˆ¶**ï¼š
   - å¾®ä¿¡å¯¹æ–‡ä»¶å¤§å°æœ‰é™åˆ¶ï¼Œè¿‡å¤§çš„æ–‡ä»¶å¯èƒ½æ— æ³•å‘é€
   - å»ºè®®å°†å¤§æ–‡ä»¶åˆ†å‰²æˆ–å‹ç¼©åå‘é€

2. **æ–‡ä»¶ç±»å‹**ï¼š
   - ä¸åŒçš„æ–‡ä»¶ç±»å‹å¯èƒ½éœ€è¦ä¸åŒçš„å¤„ç†æ–¹å¼
   - æŸäº›æ–‡ä»¶ç±»å‹å¯èƒ½ä¼šè¢«å¾®ä¿¡é™åˆ¶æˆ–æ‹¦æˆª

3. **ä¸Šä¼ é€Ÿåº¦**ï¼š
   - æ–‡ä»¶ä¸Šä¼ é€Ÿåº¦å¯èƒ½è¾ƒæ…¢ï¼Œç‰¹åˆ«æ˜¯å¤§æ–‡ä»¶
   - å¯¹äºå¤§æ–‡ä»¶ï¼Œå¯ä»¥å…ˆå‘é€"ä¸Šä¼ ä¸­"çš„æç¤ºæ¶ˆæ¯

4. **é”™è¯¯å¤„ç†**ï¼š
   - æ–‡ä»¶ä¸Šä¼ å’Œå‘é€è¿‡ç¨‹ä¸­å¯èƒ½å‡ºç°å„ç§é”™è¯¯ï¼Œéœ€è¦å®Œå–„çš„é”™è¯¯å¤„ç†æœºåˆ¶
   - å¸¸è§é”™è¯¯åŒ…æ‹¬æ–‡ä»¶ä¸å­˜åœ¨ã€æ–‡ä»¶æ ¼å¼ä¸æ”¯æŒã€ç½‘ç»œé—®é¢˜ç­‰

5. **ä¸´æ—¶æ–‡ä»¶å¤„ç†**ï¼š
   - å¦‚æœéœ€è¦ç”Ÿæˆä¸´æ—¶æ–‡ä»¶ï¼Œè®°å¾—åœ¨å‘é€ååŠæ—¶æ¸…ç†
   - ä½¿ç”¨`try/finally`ç¡®ä¿ä¸´æ—¶æ–‡ä»¶è¢«æ¸…ç†

## 8. æµ‹è¯•å’ŒéªŒè¯

### 8.1 æµ‹è¯•ä¸åŒæŸ¥è¯¢åœºæ™¯

ç¡®ä¿æµ‹è¯•æ‰€æœ‰å¯èƒ½çš„æŸ¥è¯¢åœºæ™¯ï¼š

- å½“å¤©å¤©æ°”
- æ˜å¤©å¤©æ°”
- åå¤©å¤©æ°”
- ä¸ƒå¤©å¤©æ°”
- ç‰¹å®šåŸå¸‚å¤©æ°”

### 8.2 æµ‹è¯•é”™è¯¯æƒ…å†µ

æµ‹è¯•å„ç§é”™è¯¯æƒ…å†µï¼š

- APIè¿”å›é”™è¯¯
- æ•°æ®ç¼ºå¤±æˆ–ä¸ºNone
- ç½‘ç»œé—®é¢˜
- æ— æ•ˆçš„æŸ¥è¯¢å‚æ•°

## 9. æœ€ä½³å®è·µ

### 9.1 å¤„ç†åçˆ¬æœºåˆ¶

1. **è®¾ç½®åˆé€‚çš„ User-Agent**ï¼šæ¨¡æ‹Ÿæµè§ˆå™¨è¯·æ±‚ï¼Œé¿å…è¢«è¯†åˆ«ä¸ºçˆ¬è™«ã€‚
2. **æ·»åŠ  Referer å¤´**ï¼šè®¸å¤š API ä¼šæ£€æŸ¥ Refererï¼Œè®¾ç½®ä¸º API çš„åŸŸåã€‚
3. **æ·»åŠ  Accept å¤´**ï¼šæ ¹æ®è¯·æ±‚çš„å†…å®¹ç±»å‹è®¾ç½®ï¼Œå¦‚å›¾ç‰‡è¯·æ±‚è®¾ç½®ä¸º `image/*`ã€‚
4. **ä½¿ç”¨å¤šä¸ª API æº**ï¼šå½“ä¸€ä¸ª API æºå¤±è´¥æ—¶ï¼Œå¯ä»¥å°è¯•å…¶ä»– API æºã€‚

```python
headers = {
    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
    'Accept': 'image/webp, image/apng, image/*',
    'Referer': 'https://api.example.com/'
}
```

### 9.2 å¼‚æ­¥ HTTP è¯·æ±‚

1. **ä½¿ç”¨ aiohttp**ï¼šæ›¿ä»£ requests è¿›è¡Œå¼‚æ­¥ HTTP è¯·æ±‚ã€‚
2. **è®¾ç½®è¶…æ—¶**ï¼šé¿å…è¯·æ±‚é•¿æ—¶é—´æŒ‚èµ·ã€‚
3. **ä½¿ç”¨ ClientSession**ï¼šé‡ç”¨è¿æ¥ï¼Œæé«˜æ€§èƒ½ã€‚

```python
async with aiohttp.ClientSession() as session:
    async with session.get(url, headers=headers, timeout=15) as response:
        if response.status == 200:
            data = await response.read()
            return data
```

### 9.3 ä¸´æ—¶æ–‡ä»¶å¤„ç†

1. **ä½¿ç”¨ Path å¯¹è±¡**ï¼šä½¿ç”¨ `pathlib.Path` å¤„ç†æ–‡ä»¶è·¯å¾„ï¼Œæ›´åŠ å®‰å…¨å’Œè·¨å¹³å°ã€‚
2. **åˆ›å»ºä¸´æ—¶ç›®å½•**ï¼šä½¿ç”¨ `mkdir(exist_ok=True)` ç¡®ä¿ç›®å½•å­˜åœ¨ã€‚
3. **åŠæ—¶æ¸…ç†**ï¼šä½¿ç”¨ `try/finally` ç¡®ä¿ä¸´æ—¶æ–‡ä»¶è¢«æ¸…ç†ã€‚
4. **ä½¿ç”¨æ—¶é—´æˆ³**ï¼šä½¿ç”¨æ—¶é—´æˆ³åˆ›å»ºå”¯ä¸€æ–‡ä»¶åï¼Œé¿å…å†²çªã€‚

```python
temp_dir = Path("temp")
temp_dir.mkdir(exist_ok=True)
timestamp = int(time.time())
file_path = temp_dir / f"file_{timestamp}.tmp"

try:
    # ä½¿ç”¨ä¸´æ—¶æ–‡ä»¶
    with open(file_path, 'wb') as f:
        f.write(data)
    # å¤„ç†æ–‡ä»¶...
finally:
    # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    if file_path.exists():
        file_path.unlink()
```

### 9.4 é”™è¯¯å¤„ç†

1. **æ•è·å…·ä½“å¼‚å¸¸**ï¼šå°½å¯èƒ½æ•è·å…·ä½“çš„å¼‚å¸¸ç±»å‹ï¼Œè€Œä¸æ˜¯ç¬¼ç»Ÿçš„ `Exception`ã€‚
2. **è®°å½•è¯¦ç»†æ—¥å¿—**ï¼šè®°å½•å¼‚å¸¸ä¿¡æ¯å’Œå †æ ˆè·Ÿè¸ªï¼Œä¾¿äºè°ƒè¯•ã€‚
3. **æä¾›å›é€€ç­–ç•¥**ï¼šå½“ä¸»è¦æ–¹æ³•å¤±è´¥æ—¶ï¼Œæä¾›å¤‡é€‰æ–¹æ¡ˆã€‚
4. **è¿”å›å‹å¥½é”™è¯¯æ¶ˆæ¯**ï¼šå‘ç”¨æˆ·æä¾›æœ‰æ„ä¹‰çš„é”™è¯¯ä¿¡æ¯ã€‚

```python
try:
    # å°è¯•ä¸»è¦æ–¹æ³•
    result = await primary_method()
    return result
except aiohttp.ClientError as e:
    logger.error(f"HTTP è¯·æ±‚å¤±è´¥: {e}")
    try:
        # å°è¯•å¤‡é€‰æ–¹æ³•
        result = await fallback_method()
        return result
    except Exception as e:
        logger.error(f"å¤‡é€‰æ–¹æ³•ä¹Ÿå¤±è´¥: {e}")
        return "è·å–æ•°æ®å¤±è´¥ï¼Œè¯·ç¨åå†è¯•"
except Exception as e:
    logger.error(f"æœªé¢„æœŸçš„é”™è¯¯: {e}")
    logger.error(traceback.format_exc())
    return "å‘ç”ŸæœªçŸ¥é”™è¯¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜"
```

## 10. æŒç»­æ›´æ–°

æœ¬æ–‡æ¡£å°†éšç€æ›´å¤šæ’ä»¶çš„è¿ç§»è€Œæ›´æ–°ï¼Œæ·»åŠ æ–°çš„æœ€ä½³å®è·µå’Œæ³¨æ„äº‹é¡¹ã€‚å¦‚æœæ‚¨åœ¨è¿ç§»è¿‡ç¨‹ä¸­å‘ç°æ–°çš„é—®é¢˜æˆ–è§£å†³æ–¹æ¡ˆï¼Œè¯·æ›´æ–°æœ¬æ–‡æ¡£ã€‚

## 11. å·²è¿ç§»æ’ä»¶åˆ—è¡¨

1. Apilot - å¤©æ°”æŸ¥è¯¢æ’ä»¶
   - ä¸»è¦åŠŸèƒ½ï¼šæŸ¥è¯¢å½“å¤©ã€æ˜å¤©ã€åå¤©å’Œä¸ƒå¤©å¤©æ°”
   - è¿ç§»æ—¥æœŸï¼š2023-05-07
   - ä¸»è¦æ”¹è¿›ï¼š
     - ä¿®å¤äº†åå¤©å¤©æ°”æŸ¥è¯¢
     - ç»Ÿä¸€äº†è¡¨æƒ…ç¬¦å·
     - æ”¹è¿›äº†é”™è¯¯å¤„ç†
     - æ·»åŠ äº†å¤©æ°”é¢„è­¦ä¿¡æ¯æ˜¾ç¤º
     - ä¼˜åŒ–äº†Noneå€¼å¤„ç†

## 12. å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### 12.1 Noneå€¼æ˜¾ç¤ºé—®é¢˜

APIè¿”å›çš„æ•°æ®ä¸­å¯èƒ½åŒ…å«Noneå€¼ï¼Œè¿™äº›å€¼å¦‚æœç›´æ¥æ˜¾ç¤ºä¼šå½±å“ç”¨æˆ·ä½“éªŒã€‚è§£å†³æ–¹æ¡ˆï¼š

```python
# æ£€æŸ¥å¹¶æ›¿æ¢Noneå€¼
value = data.get('field', 'é»˜è®¤å€¼')
if value is None or value == "None":
    value = 'é»˜è®¤å€¼'
```

### 12.2 ç¼ºå°‘åŸç‰ˆåŠŸèƒ½

åœ¨è¿ç§»è¿‡ç¨‹ä¸­ï¼Œå¾ˆå®¹æ˜“å¿½ç•¥åŸç‰ˆæ’ä»¶çš„æŸäº›åŠŸèƒ½ï¼ˆå¦‚å¤©æ°”é¢„è­¦ä¿¡æ¯ï¼‰ã€‚è§£å†³æ–¹æ¡ˆï¼š

1. ä»”ç»†ç ”ç©¶åŸç‰ˆæ’ä»¶çš„æ‰€æœ‰åŠŸèƒ½
2. åˆ›å»ºåŠŸèƒ½æ¸…å•ï¼Œç¡®ä¿æ‰€æœ‰åŠŸèƒ½éƒ½è¢«è¿ç§»
3. æµ‹è¯•å„ç§åœºæ™¯ï¼Œç¡®ä¿æ‰€æœ‰åŠŸèƒ½éƒ½æ­£å¸¸å·¥ä½œ
4. **ä¸¥æ ¼æŒ‰ç…§åŸç‰ˆçš„å®ç°é€»è¾‘è¿›è¡Œè¿ç§»ï¼Œä¸è¦è‡ªè¡Œåˆ›å»ºæ–°çš„é€»è¾‘**

ç‰¹åˆ«æ³¨æ„ï¼š
- ä¸è¦"é—­é—¨é€ è½¦"ï¼Œå§‹ç»ˆå‚è€ƒåŸç‰ˆä»£ç 
- å¯¹äºå¤æ‚åŠŸèƒ½ï¼ˆå¦‚å¤©æ°”é¢„è­¦ä¿¡æ¯ï¼‰ï¼Œåº”è¯¥ç›´æ¥å¤åˆ¶åŸç‰ˆçš„å®ç°é€»è¾‘
- ä¿æŒä¸åŸç‰ˆç›¸åŒçš„æ•°æ®å¤„ç†æµç¨‹å’Œæ˜¾ç¤ºæ ¼å¼

### 12.3 è¡¨æƒ…ç¬¦å·ä¸ä¸€è‡´

ä¸åŒçš„è¡¨æƒ…ç¬¦å·å¯èƒ½å¯¼è‡´ç”¨æˆ·ä½“éªŒä¸ä¸€è‡´ã€‚è§£å†³æ–¹æ¡ˆï¼š

1. åˆ›å»ºè¡¨æƒ…ç¬¦å·æ˜ å°„è¡¨ï¼Œç¡®ä¿ä¸€è‡´æ€§
2. ä½¿ç”¨æ¡ä»¶è¯­å¥ä¸ºä¸åŒçŠ¶æ€é€‰æ‹©é€‚å½“çš„è¡¨æƒ…ç¬¦å·
3. å‚è€ƒåŸç‰ˆæ’ä»¶çš„è¡¨æƒ…ç¬¦å·ä½¿ç”¨

### 12.4 å›¾ç‰‡å’Œè§†é¢‘å‘é€é—®é¢˜

åœ¨XXXPADä¸­å‘é€å›¾ç‰‡å’Œè§†é¢‘æ—¶å¯èƒ½é‡åˆ°çš„é—®é¢˜ï¼š

1. **åçˆ¬æœºåˆ¶**ï¼šè®¸å¤šAPIä¼šæ£€æµ‹çˆ¬è™«è¡Œä¸ºï¼Œéœ€è¦è®¾ç½®é€‚å½“çš„è¯·æ±‚å¤´ã€‚
2. **å¼‚æ­¥å¤„ç†**ï¼šç¡®ä¿ä½¿ç”¨å¼‚æ­¥HTTPå®¢æˆ·ç«¯ä¸‹è½½åª’ä½“å†…å®¹ã€‚
3. **å†…å®¹ç±»å‹æ£€æŸ¥**ï¼šéªŒè¯å“åº”çš„Content-Typeç¡®ä¿æ˜¯æ­£ç¡®çš„åª’ä½“ç±»å‹ã€‚
4. **è§†é¢‘å°é¢**ï¼šä¸ºè§†é¢‘æ·»åŠ å°é¢å¯ä»¥æå‡ç”¨æˆ·ä½“éªŒã€‚

### 12.5 åŠŸèƒ½å®Œæ•´æ€§å’Œä»£ç å¤ç”¨

åœ¨è¿ç§»æ’ä»¶æ—¶ï¼Œéœ€è¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š

1. **åŠŸèƒ½å®Œæ•´æ€§**ï¼šç¡®ä¿è¿ç§»åŸç‰ˆæ’ä»¶çš„æ‰€æœ‰åŠŸèƒ½ï¼Œä¸è¦é—æ¼ä»»ä½•åŠŸèƒ½ç‚¹ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªå¤šåª’ä½“æ’ä»¶å¯èƒ½æ”¯æŒå¤šç§ç±»å‹çš„å†…å®¹ï¼Œåº”è¯¥å…¨éƒ¨è¿ç§»ã€‚

2. **ä»£ç å¤ç”¨**ï¼šå¯¹äºå¤šä¸ªç±»ä¼¼åŠŸèƒ½ï¼Œåº”è¯¥åˆ›å»ºé€šç”¨æ–¹æ³•é¿å…ä»£ç é‡å¤ï¼š

```python
# é€šç”¨æ–¹æ³•ç¤ºä¾‹
async def _process_content(self, url, content_type, params=None):
    """Generic method to process different types of content"""
    # é€šç”¨å¤„ç†é€»è¾‘
    # ...

# ç‰¹å®šåŠŸèƒ½è°ƒç”¨é€šç”¨æ–¹æ³•
async def get_content_type_a(self):
    """Get content type A"""
    return await self._process_content(self.type_a_url, "type_a")

async def get_content_type_b(self):
    """Get content type B"""
    return await self._process_content(self.type_b_url, "type_b")
```

3. **é…ç½®æ–‡ä»¶ç®¡ç†**ï¼šå°†æ‰€æœ‰å¯é…ç½®é¡¹æ”¾åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œæ–¹ä¾¿ç”¨æˆ·è‡ªå®šä¹‰ï¼š

```toml
[triggers]
# è§¦å‘è¯é…ç½®
trigger_a = 'è§¦å‘è¯A'
trigger_b = 'è§¦å‘è¯B'
# ...

[apis]
# APIåœ°å€é…ç½®
api_url_a = "https://api.example.com/endpoint_a"
api_url_b = "https://api.example.com/endpoint_b"
# ...
```

4. **å¤„ç†é€»è¾‘ä¸€è‡´æ€§**ï¼šå¯¹äºç±»ä¼¼çš„åŠŸèƒ½ï¼Œç¡®ä¿ä½¿ç”¨ç›¸åŒçš„å¤„ç†é€»è¾‘ï¼Œä¿æŒä»£ç å’Œç”¨æˆ·ä½“éªŒçš„ä¸€è‡´æ€§ã€‚ä¾‹å¦‚ï¼Œæ‰€æœ‰å¤šåª’ä½“å†…å®¹çš„ä¸‹è½½ã€å¤„ç†å’Œå‘é€åº”è¯¥éµå¾ªç›¸åŒçš„æ¨¡å¼ã€‚

## 13. å‘é€å¡ç‰‡æ¶ˆæ¯

### 13.1 å¡ç‰‡æ¶ˆæ¯ç±»å‹

xxxbotæ”¯æŒå‘é€å¤šç§ç±»å‹çš„å¡ç‰‡æ¶ˆæ¯ï¼ŒåŒ…æ‹¬ï¼š

1. **éŸ³ä¹å¡ç‰‡**ï¼šç”¨äºåˆ†äº«éŸ³ä¹ï¼ŒåŒ…å«æ­Œæ›²æ ‡é¢˜ã€æ­Œæ‰‹ã€å°é¢å’Œæ’­æ”¾é“¾æ¥
2. **è§†é¢‘å¡ç‰‡**ï¼šç”¨äºåˆ†äº«è§†é¢‘ï¼ŒåŒ…å«è§†é¢‘æ ‡é¢˜ã€æè¿°ã€å°é¢å’Œæ’­æ”¾é“¾æ¥
3. **é“¾æ¥å¡ç‰‡**ï¼šç”¨äºåˆ†äº«ç½‘é¡µé“¾æ¥ï¼ŒåŒ…å«æ ‡é¢˜ã€æè¿°ã€ç¼©ç•¥å›¾å’Œé“¾æ¥
4. **åç‰‡å¡ç‰‡**ï¼šç”¨äºåˆ†äº«è”ç³»äººåç‰‡

### 13.2 å‘é€å¡ç‰‡æ¶ˆæ¯çš„æ–¹æ³•

#### 13.2.1 ä½¿ç”¨send_app_messageæ–¹æ³•

```python
await bot.send_app_message(wxid, xml, type)
```

**å‚æ•°è¯´æ˜**ï¼š
- `wxid`: æ¥æ”¶äººçš„å¾®ä¿¡ID
- `xml`: å¡ç‰‡æ¶ˆæ¯çš„XMLå†…å®¹
- `type`: å¡ç‰‡æ¶ˆæ¯ç±»å‹ï¼Œä¸åŒç±»å‹å¯¹åº”ä¸åŒçš„å€¼ï¼š
  - `3`: éŸ³ä¹å¡ç‰‡
  - `5`: è§†é¢‘å¡ç‰‡
  - `6`: é“¾æ¥å¡ç‰‡

#### 13.2.2 ä½¿ç”¨send_link_messageæ–¹æ³•

```python
await bot.send_link_message(wxid, url, title, description, thumb_url)
```

**å‚æ•°è¯´æ˜**ï¼š
- `wxid`: æ¥æ”¶äººçš„å¾®ä¿¡ID
- `url`: é“¾æ¥URL
- `title`: é“¾æ¥æ ‡é¢˜
- `description`: é“¾æ¥æè¿°
- `thumb_url`: ç¼©ç•¥å›¾URL

#### 13.2.3 ä½¿ç”¨send_card_messageæ–¹æ³•

```python
await bot.send_card_message(wxid, card_wxid, card_nickname, card_alias="")
```

**å‚æ•°è¯´æ˜**ï¼š
- `wxid`: æ¥æ”¶äººçš„å¾®ä¿¡ID
- `card_wxid`: åç‰‡ç”¨æˆ·çš„å¾®ä¿¡ID
- `card_nickname`: åç‰‡ç”¨æˆ·çš„æ˜µç§°
- `card_alias`: åç‰‡ç”¨æˆ·çš„å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰

### 13.3 æ„é€ å¡ç‰‡æ¶ˆæ¯XML

#### 13.3.1 éŸ³ä¹å¡ç‰‡XML

ä»¥ä¸‹æ˜¯æ„é€ éŸ³ä¹å¡ç‰‡XMLçš„ç¤ºä¾‹ä»£ç ï¼ˆæ¥è‡ªMusicæ’ä»¶ï¼‰ï¼š

```python
# æ„é€ éŸ³ä¹å¡ç‰‡XML
xml = f"""<appmsg appid="wx79f2c4418704b4f8" sdkver="0">
<title>{title}</title>
<des>{singer}</des>
<action>view</action>
<type>3</type>
<showtype>0</showtype>
<content/>
<url>{url}</url>
<dataurl>{music_url}</dataurl>
<lowurl>{url}</lowurl>
<lowdataurl>{music_url}</lowdataurl>
<recorditem/>
<thumburl>{cover_url}</thumburl>
<messageaction/>
<laninfo/>
<extinfo/>
<sourceusername/>
<sourcedisplayname/>
<songlyric>{lyric}</songlyric>
<commenturl/>
<appattach>
<totallen>0</totallen>
<attachid/>
<emoticonmd5/>
<fileext/>
<aeskey/>
</appattach>
<webviewshared>
<publisherId/>
<publisherReqId>0</publisherReqId>
</webviewshared>
<weappinfo>
<pagepath/>
<username/>
<appid/>
<appservicetype>0</appservicetype>
</weappinfo>
<websearch/>
<songalbumurl>{cover_url}</songalbumurl>
</appmsg>
<fromusername>{bot.wxid}</fromusername>
<scene>0</scene>
<appinfo>
<version>1</version>
<appname/>
</appinfo>
<commenturl/>"""

# å‘é€éŸ³ä¹å¡ç‰‡
await bot.send_app_message(wxid, xml, 3)
```

#### 13.3.2 è§†é¢‘å¡ç‰‡XML

ä»¥ä¸‹æ˜¯æ„é€ è§†é¢‘å¡ç‰‡XMLçš„ç¤ºä¾‹ä»£ç ï¼ˆæ¥è‡ªDouyinParseræ’ä»¶ï¼‰ï¼š

```python
# æ„é€ è§†é¢‘å¡ç‰‡XML
xml = f"""<appmsg appid="wx79f2c4418704b4f8" sdkver="0">
<title>{title}</title>
<des>{description}</des>
<action>view</action>
<type>5</type>
<showtype>0</showtype>
<content/>
<url>{video_url}</url>
<dataurl>{video_url}</dataurl>
<lowurl>{video_url}</lowurl>
<lowdataurl>{video_url}</lowdataurl>
<recorditem/>
<thumburl>{thumb_url}</thumburl>
<messageaction/>
<laninfo/>
<extinfo/>
<sourceusername/>
<sourcedisplayname/>
<commenturl/>
<appattach>
<totallen>0</totallen>
<attachid/>
<emoticonmd5/>
<fileext/>
<aeskey/>
</appattach>
<webviewshared>
<publisherId/>
<publisherReqId>0</publisherReqId>
</webviewshared>
<weappinfo>
<pagepath/>
<username/>
<appid/>
<appservicetype>0</appservicetype>
</weappinfo>
<websearch/>
</appmsg>
<fromusername>{bot.wxid}</fromusername>
<scene>0</scene>
<appinfo>
<version>1</version>
<appname/>
</appinfo>
<commenturl/>"""

# å‘é€è§†é¢‘å¡ç‰‡
await bot.send_app_message(wxid, xml, 5)
```

### 13.4 å¡ç‰‡æ¶ˆæ¯æ³¨æ„äº‹é¡¹

1. **XMLæ ¼å¼**ï¼š
   - XMLæ ¼å¼å¿…é¡»ä¸¥æ ¼æŒ‰ç…§ç¤ºä¾‹æ ¼å¼æ„é€ 
   - ä¸åŒç±»å‹çš„å¡ç‰‡æ¶ˆæ¯æœ‰ä¸åŒçš„XMLç»“æ„
   - `type`å­—æ®µå¿…é¡»ä¸send_app_messageçš„typeå‚æ•°ä¸€è‡´

2. **URLå¤„ç†**ï¼š
   - æ‰€æœ‰URLå¿…é¡»æ˜¯æœ‰æ•ˆçš„å®Œæ•´URL
   - éŸ³ä¹å¡ç‰‡ä¸­çš„`dataurl`å¿…é¡»æ˜¯ç›´æ¥å¯æ’­æ”¾çš„éŸ³é¢‘URL
   - è§†é¢‘å¡ç‰‡ä¸­çš„`dataurl`å¿…é¡»æ˜¯ç›´æ¥å¯æ’­æ”¾çš„è§†é¢‘URL

3. **å°é¢å›¾ç‰‡**ï¼š
   - `thumburl`å­—æ®µå¿…é¡»æ˜¯æœ‰æ•ˆçš„å›¾ç‰‡URL
   - å»ºè®®ä½¿ç”¨é«˜è´¨é‡çš„å°é¢å›¾ç‰‡ä»¥æå‡ç”¨æˆ·ä½“éªŒ

4. **é”™è¯¯å¤„ç†**ï¼š
   - å‘é€å¡ç‰‡æ¶ˆæ¯å¯èƒ½å› ä¸ºå„ç§åŸå› å¤±è´¥ï¼Œåº”è¯¥æœ‰é€‚å½“çš„é”™è¯¯å¤„ç†
   - å¯ä»¥åœ¨å¡ç‰‡æ¶ˆæ¯å‘é€å¤±è´¥æ—¶å›é€€åˆ°å‘é€æ™®é€šæ–‡æœ¬æ¶ˆæ¯

5. **å…¼å®¹æ€§**ï¼š
   - ä¸åŒç‰ˆæœ¬çš„å¾®ä¿¡å¯èƒ½å¯¹å¡ç‰‡æ¶ˆæ¯çš„æ”¯æŒæœ‰æ‰€ä¸åŒ
   - å»ºè®®åœ¨å¤šä¸ªç¯å¢ƒä¸­æµ‹è¯•å¡ç‰‡æ¶ˆæ¯çš„æ˜¾ç¤ºæ•ˆæœ

## 14. å¼•ç”¨æ¶ˆæ¯å¤„ç†

### 14.1 å¼•ç”¨æ¶ˆæ¯æ¦‚è¿°

xxxbotæ¡†æ¶æ”¯æŒå¤„ç†å¼•ç”¨æ¶ˆæ¯ï¼Œå¯ä»¥è·å–è¢«å¼•ç”¨æ¶ˆæ¯çš„å†…å®¹ã€å‘é€è€…ç­‰ä¿¡æ¯ã€‚å¼•ç”¨æ¶ˆæ¯åœ¨ä»¥ä¸‹åœºæ™¯ä¸­ç‰¹åˆ«æœ‰ç”¨ï¼š

1. **ä¸Šä¸‹æ–‡ç†è§£**ï¼šè·å–ç”¨æˆ·å¼•ç”¨çš„æ¶ˆæ¯å†…å®¹ï¼Œç†è§£ç”¨æˆ·çš„å›å¤ä¸Šä¸‹æ–‡
2. **å¼•ç”¨å›¾ç‰‡å¤„ç†**ï¼šå¤„ç†ç”¨æˆ·å¼•ç”¨çš„å›¾ç‰‡æ¶ˆæ¯ï¼Œä¾‹å¦‚å›¾ç‰‡ç¼–è¾‘ã€å›¾ç‰‡åˆ†æç­‰
3. **å¼•ç”¨å›å¤**ï¼šé’ˆå¯¹ç‰¹å®šæ¶ˆæ¯è¿›è¡Œå›å¤

### 14.2 æ¥æ”¶å¼•ç”¨æ¶ˆæ¯

#### 14.2.1 ä½¿ç”¨on_quote_messageè£…é¥°å™¨

```python
from utils.decorators import on_quote_message

@on_quote_message(priority=20)
async def handle_quote(self, bot: WechatAPIClient, message: dict):
    """å¤„ç†å¼•ç”¨æ¶ˆæ¯"""
    if not self.enable:
        return

    # æå–å¼•ç”¨æ¶ˆæ¯çš„å†…å®¹
    content = message["Content"].strip()
    quote_info = message.get("Quote", {})
    quoted_content = quote_info.get("Content", "")
    quoted_sender = quote_info.get("Nickname", "")

    # å¤„ç†å¼•ç”¨æ¶ˆæ¯
    logger.info(f"æ”¶åˆ°å¼•ç”¨æ¶ˆæ¯ï¼Œå†…å®¹: {content}ï¼Œå¼•ç”¨å†…å®¹: {quoted_content}ï¼Œå‘é€è€…: {quoted_sender}")
```

#### 14.2.2 å¼•ç”¨æ¶ˆæ¯çš„ç»“æ„

å¼•ç”¨æ¶ˆæ¯åœ¨messageå­—å…¸ä¸­åŒ…å«ä¸€ä¸ª"Quote"å­—æ®µï¼Œå…¶ä¸­åŒ…å«è¢«å¼•ç”¨æ¶ˆæ¯çš„è¯¦ç»†ä¿¡æ¯ï¼š

```python
quote_info = message.get("Quote", {})
# è¢«å¼•ç”¨æ¶ˆæ¯çš„å†…å®¹
quoted_content = quote_info.get("Content", "")
# è¢«å¼•ç”¨æ¶ˆæ¯çš„å‘é€è€…æ˜µç§°
quoted_sender = quote_info.get("Nickname", "")
# è¢«å¼•ç”¨æ¶ˆæ¯çš„ID
quoted_msg_id = quote_info.get("NewMsgId", "")
# è¢«å¼•ç”¨æ¶ˆæ¯çš„å‘é€æ—¶é—´
quoted_create_time = quote_info.get("Createtime", "")
# è¢«å¼•ç”¨æ¶ˆæ¯çš„å‘é€è€…ID
quoted_from_wxid = quote_info.get("FromWxid", "")
```

### 14.3 å¤„ç†å¼•ç”¨çš„åª’ä½“å†…å®¹

#### 14.3.1 è·å–å¼•ç”¨çš„å›¾ç‰‡

æ¡†æ¶æä¾›äº†ReferenceHandlerç±»æ¥å¤„ç†å¼•ç”¨æ¶ˆæ¯ä¸­çš„åª’ä½“å†…å®¹ï¼Œç‰¹åˆ«æ˜¯å›¾ç‰‡ï¼š

```python
from common.reference_handler import ReferenceHandler

# è·å–å¼•ç”¨æ¶ˆæ¯çš„ä¿¡æ¯
ref_info = ReferenceHandler.get_reference_info(context)

# å¦‚æœæ˜¯å¼•ç”¨å›¾ç‰‡æ¶ˆæ¯ï¼Œè·å–å›¾ç‰‡è·¯å¾„
if ref_info and ref_info.get('type') == ContextType.IMAGE:
    # ç¡®ä¿å¼•ç”¨çš„åª’ä½“å·²å‡†å¤‡å¥½
    if hasattr(context, 'msg') and hasattr(context.msg, '_prepare_fn'):
        ReferenceHandler.prepare_reference_media(context)

    # è·å–å¼•ç”¨çš„å›¾ç‰‡è·¯å¾„
    image_path = ReferenceHandler.get_image_from_reference(context)
    if image_path and os.path.exists(image_path):
        # å¤„ç†å›¾ç‰‡
        logger.info(f"è·å–åˆ°å¼•ç”¨å›¾ç‰‡: {image_path}")
```

### 14.4 å¼•ç”¨æ¶ˆæ¯å¤„ç†ç¤ºä¾‹

ä»¥ä¸‹æ˜¯ä¸€ä¸ªå®Œæ•´çš„å¼•ç”¨æ¶ˆæ¯å¤„ç†ç¤ºä¾‹ï¼Œå±•ç¤ºå¦‚ä½•è·å–å¼•ç”¨æ¶ˆæ¯çš„å†…å®¹å¹¶å¤„ç†å¼•ç”¨çš„å›¾ç‰‡ï¼š

```python
@on_quote_message(priority=20)
async def handle_quote(self, bot: WechatAPIClient, message: dict):
    """å¤„ç†å¼•ç”¨æ¶ˆæ¯"""
    if not self.enable:
        return

    # æå–å¼•ç”¨æ¶ˆæ¯çš„å†…å®¹
    content = message["Content"].strip()
    quote_info = message.get("Quote", {})
    quoted_content = quote_info.get("Content", "")
    quoted_sender = quote_info.get("Nickname", "")

    # åˆ›å»ºä¸Šä¸‹æ–‡å¯¹è±¡
    context = self._create_context_from_message(message)

    # è·å–å¼•ç”¨çš„åª’ä½“å†…å®¹
    from common.reference_handler import ReferenceHandler

    # è·å–å¼•ç”¨æ¶ˆæ¯çš„ä¿¡æ¯
    ref_info = ReferenceHandler.get_reference_info(context)

    # å¦‚æœæ˜¯å¼•ç”¨å›¾ç‰‡æ¶ˆæ¯ï¼Œè·å–å›¾ç‰‡è·¯å¾„
    if ref_info and ref_info.get('type') == ContextType.IMAGE:
        # ç¡®ä¿å¼•ç”¨çš„åª’ä½“å·²å‡†å¤‡å¥½
        if hasattr(context, 'msg') and hasattr(context.msg, '_prepare_fn'):
            ReferenceHandler.prepare_reference_media(context)

        # è·å–å¼•ç”¨çš„å›¾ç‰‡è·¯å¾„
        image_path = ReferenceHandler.get_image_from_reference(context)
        if image_path and os.path.exists(image_path):
            # å¤„ç†å›¾ç‰‡
            logger.info(f"è·å–åˆ°å¼•ç”¨å›¾ç‰‡: {image_path}")

            # ç¤ºä¾‹ï¼šå›å¤å›¾ç‰‡ä¿¡æ¯
            reply_text = f"æ”¶åˆ°æ‚¨å¼•ç”¨çš„å›¾ç‰‡ï¼Œè·¯å¾„ä¸º: {image_path}"
            await bot.send_text_message(message["FromWxid"], reply_text)
    else:
        # å¤„ç†æ™®é€šå¼•ç”¨æ¶ˆæ¯
        reply_text = f"æ‚¨å¼•ç”¨äº† {quoted_sender} çš„æ¶ˆæ¯: {quoted_content}"
        await bot.send_text_message(message["FromWxid"], reply_text)
```

### 14.5 æ³¨æ„äº‹é¡¹

1. **å¼•ç”¨æ¶ˆæ¯è§£æ**ï¼šå¼•ç”¨æ¶ˆæ¯çš„å†…å®¹å¯èƒ½åŒ…å«XMLæ ¼å¼çš„æ•°æ®ï¼Œéœ€è¦æ­£ç¡®è§£æ
2. **åª’ä½“å†…å®¹å¤„ç†**ï¼šå¼•ç”¨çš„åª’ä½“å†…å®¹ï¼ˆå¦‚å›¾ç‰‡ï¼‰éœ€è¦ä½¿ç”¨ReferenceHandlerç±»å¤„ç†
3. **ä¸Šä¸‹æ–‡å…³è”**ï¼šå¼•ç”¨æ¶ˆæ¯é€šå¸¸ä¸ä¹‹å‰çš„å¯¹è¯æœ‰å…³è”ï¼Œå¤„ç†æ—¶éœ€è¦è€ƒè™‘ä¸Šä¸‹æ–‡
4. **é”™è¯¯å¤„ç†**ï¼šå¼•ç”¨æ¶ˆæ¯çš„è§£æå¯èƒ½å¤±è´¥ï¼Œéœ€è¦é€‚å½“çš„é”™è¯¯å¤„ç†æœºåˆ¶

## 15. æ¶ˆæ¯å‘é€æ—¶çš„æ¥æ”¶è€…IDé€‰æ‹©

åœ¨xxxbotæ¡†æ¶ä¸­ï¼Œå‘é€æ¶ˆæ¯æ—¶éœ€è¦æŒ‡å®šæ¥æ”¶è€…IDã€‚æ ¹æ®ä¸åŒçš„æ¶ˆæ¯ç±»å‹å’Œåœºæ™¯ï¼Œå¯èƒ½éœ€è¦ä½¿ç”¨ä¸åŒçš„æ¥æ”¶è€…IDã€‚

### 15.1 æ¥æ”¶è€…IDçš„æ¥æº

æ¶ˆæ¯å¯¹è±¡ä¸­é€šå¸¸åŒ…å«ä»¥ä¸‹å‡ ç§å¯èƒ½çš„æ¥æ”¶è€…IDï¼š

1. **chat_id**: é€šå¸¸æ˜¯èŠå¤©çš„IDï¼Œå¯èƒ½æ˜¯ç¾¤èŠIDæˆ–ä¸ªäººèŠå¤©ID
2. **from_wxid**: æ¶ˆæ¯æ¥æºçš„å¾®ä¿¡IDï¼Œé€šå¸¸æ˜¯å‘é€æ¶ˆæ¯çš„èŠå¤©çª—å£ID
3. **user_id**: ç”¨æˆ·IDï¼Œé€šå¸¸æ˜¯å½“å‰ç”¨æˆ·çš„ID
4. **sender_wxid**: æ¶ˆæ¯å‘é€è€…çš„å¾®ä¿¡IDï¼Œåœ¨ç¾¤èŠä¸­æ˜¯ç¾¤æˆå‘˜çš„ID

### 15.2 é€‰æ‹©æ­£ç¡®çš„æ¥æ”¶è€…ID

åœ¨ä¸åŒåœºæ™¯ä¸‹ï¼Œåº”è¯¥é€‰æ‹©ä¸åŒçš„æ¥æ”¶è€…IDï¼š

1. **ç§èŠåœºæ™¯**ï¼š
   - `from_wxid`å’Œ`chat_id`é€šå¸¸æ˜¯ç›¸åŒçš„
   - ä¼˜å…ˆä½¿ç”¨`from_wxid`ä½œä¸ºæ¥æ”¶è€…ID

2. **ç¾¤èŠåœºæ™¯**ï¼š
   - `from_wxid`æ˜¯ç¾¤ID
   - `sender_wxid`æ˜¯ç¾¤æˆå‘˜ID
   - å›å¤ç¾¤æ¶ˆæ¯æ—¶ä½¿ç”¨`from_wxid`
   - ç§èŠç¾¤æˆå‘˜æ—¶ä½¿ç”¨`sender_wxid`

### 15.3 æœ€ä½³å®è·µ

ä¸ºäº†ç¡®ä¿æ¶ˆæ¯èƒ½å¤Ÿæ­£ç¡®å‘é€ï¼Œå»ºè®®é‡‡ç”¨ä»¥ä¸‹æœ€ä½³å®è·µï¼š

1. **ä¼˜å…ˆä½¿ç”¨from_wxid**ï¼š
   ```python
   # ä¼˜å…ˆä½¿ç”¨from_wxidï¼Œå¦‚æœä¸å¯ç”¨åˆ™ä½¿ç”¨chat_id
   if from_wxid:
       await bot.send_text_message(from_wxid, message)
   else:
       await bot.send_text_message(chat_id, message)
   ```

2. **è®°å½•è¯¦ç»†æ—¥å¿—**ï¼š
   ```python
   # è®°å½•ä½¿ç”¨çš„æ¥æ”¶è€…ID
   if from_wxid:
       await bot.send_text_message(from_wxid, message)
       logger.info(f"ä½¿ç”¨from_wxidå‘é€æ¶ˆæ¯: {from_wxid}")
   else:
       await bot.send_text_message(chat_id, message)
       logger.info(f"ä½¿ç”¨chat_idå‘é€æ¶ˆæ¯: {chat_id}")
   ```

3. **å¤„ç†å›¾ç‰‡å’Œè§†é¢‘å‘é€**ï¼š
   ```python
   # å‘é€å›¾ç‰‡
   with open(image_path, "rb") as f:
       # ä¼˜å…ˆä½¿ç”¨from_wxid
       if from_wxid:
           await bot.send_image_message(from_wxid, f.read())
       else:
           await bot.send_image_message(chat_id, f.read())
   ```

### 15.4 å¸¸è§é—®é¢˜

1. **æ¶ˆæ¯å‘é€å¤±è´¥**ï¼š
   - æ£€æŸ¥æ¥æ”¶è€…IDæ˜¯å¦æ­£ç¡®
   - å°è¯•ä½¿ç”¨ä¸åŒçš„æ¥æ”¶è€…IDï¼ˆfrom_wxid, chat_idç­‰ï¼‰
   - è®°å½•è¯¦ç»†æ—¥å¿—ï¼ŒæŸ¥çœ‹ä½¿ç”¨çš„æ¥æ”¶è€…ID

2. **å›¾ç‰‡æˆ–è§†é¢‘å‘é€å¤±è´¥**ï¼š
   - ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„æ¥æ”¶è€…ID
   - æ£€æŸ¥å›¾ç‰‡æˆ–è§†é¢‘æ•°æ®æ˜¯å¦æœ‰æ•ˆ
   - å°è¯•ä½¿ç”¨ä¸åŒçš„å‘é€æ–¹æ³•

3. **ç¾¤èŠæ¶ˆæ¯å¤„ç†**ï¼š
   - åœ¨ç¾¤èŠä¸­ï¼Œéœ€è¦åŒºåˆ†å›å¤ç¾¤æ¶ˆæ¯å’Œç§èŠç¾¤æˆå‘˜
   - å›å¤ç¾¤æ¶ˆæ¯ä½¿ç”¨ç¾¤IDï¼ˆfrom_wxidï¼‰
   - ç§èŠç¾¤æˆå‘˜ä½¿ç”¨æˆå‘˜IDï¼ˆsender_wxidï¼‰

## 16. å®šæ—¶ä»»åŠ¡å®ç°

åœ¨XXXBOTæ¡†æ¶ä¸­ï¼Œå®šæ—¶ä»»åŠ¡æ˜¯é€šè¿‡è£…é¥°å™¨æ–¹å¼å®ç°çš„ï¼Œè¿™ä¸DOWæ¡†æ¶ä¸­çš„å®ç°æ–¹å¼æœ‰æ‰€ä¸åŒã€‚æ­£ç¡®å®ç°å®šæ—¶ä»»åŠ¡å¯¹äºéœ€è¦å®šæœŸæ‰§è¡Œæ¸…ç†ã€æ›´æ–°æˆ–å…¶ä»–å‘¨æœŸæ€§æ“ä½œçš„æ’ä»¶éå¸¸é‡è¦ã€‚

### 16.1 ä½¿ç”¨è£…é¥°å™¨æ³¨å†Œå®šæ—¶ä»»åŠ¡

XXXBOTæ¡†æ¶æä¾›äº†`@schedule`è£…é¥°å™¨ï¼Œç”¨äºæ³¨å†Œå®šæ—¶ä»»åŠ¡ã€‚è¿™æ˜¯æ¨èçš„æ–¹å¼ï¼Œå› ä¸ºå®ƒä¸æ¡†æ¶çš„è®¾è®¡ç†å¿µä¸€è‡´ï¼Œå¹¶ä¸”ä¼šè‡ªåŠ¨å¤„ç†å®šæ—¶ä»»åŠ¡çš„æ³¨å†Œå’Œç®¡ç†ã€‚

```python
from utils.decorators import schedule

@schedule('interval', minutes=5)
async def scheduled_task(self, bot=None):
    """æ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡çš„å®šæ—¶ä»»åŠ¡"""
    try:
        # å®šæ—¶ä»»åŠ¡çš„å…·ä½“å®ç°
        logger.info("æ‰§è¡Œå®šæ—¶ä»»åŠ¡")
        # ...
    except Exception as e:
        logger.error(f"å®šæ—¶ä»»åŠ¡å¼‚å¸¸: {str(e)}")
        logger.error(traceback.format_exc())
```

### 16.2 è£…é¥°å™¨å‚æ•°è¯´æ˜

`@schedule`è£…é¥°å™¨æ”¯æŒå¤šç§å®šæ—¶ä»»åŠ¡ç±»å‹å’Œå‚æ•°ï¼š

1. **interval** - å›ºå®šæ—¶é—´é—´éš”æ‰§è¡Œ
   ```python
   @schedule('interval', seconds=30)  # æ¯30ç§’æ‰§è¡Œä¸€æ¬¡
   @schedule('interval', minutes=5)   # æ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
   @schedule('interval', hours=1)     # æ¯1å°æ—¶æ‰§è¡Œä¸€æ¬¡
   @schedule('interval', days=1)      # æ¯1å¤©æ‰§è¡Œä¸€æ¬¡
   ```

2. **cron** - åŸºäºcronè¡¨è¾¾å¼æ‰§è¡Œ
   ```python
   @schedule('cron', hour=3)          # æ¯å¤©å‡Œæ™¨3ç‚¹æ‰§è¡Œ
   @schedule('cron', day_of_week='mon-fri', hour=9)  # å·¥ä½œæ—¥ä¸Šåˆ9ç‚¹æ‰§è¡Œ
   @schedule('cron', minute='*/15')   # æ¯15åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
   ```

3. **date** - åœ¨æŒ‡å®šæ—¥æœŸæ—¶é—´æ‰§è¡Œä¸€æ¬¡
   ```python
   @schedule('date', run_date=datetime(2025, 12, 31, 23, 59, 59))  # åœ¨2025å¹´æœ€åä¸€ç§’æ‰§è¡Œ
   ```

### 16.3 å®šæ—¶ä»»åŠ¡æ–¹æ³•è¦æ±‚

ä½¿ç”¨`@schedule`è£…é¥°å™¨çš„æ–¹æ³•å¿…é¡»æ»¡è¶³ä»¥ä¸‹è¦æ±‚ï¼š

1. æ–¹æ³•å¿…é¡»æ˜¯å¼‚æ­¥æ–¹æ³•ï¼ˆä½¿ç”¨`async def`å®šä¹‰ï¼‰
2. æ–¹æ³•å¿…é¡»æ¥å—`bot`å‚æ•°ï¼ˆå³ä½¿ä¸ä½¿ç”¨ï¼‰
3. æ–¹æ³•åº”è¯¥åŒ…å«é€‚å½“çš„é”™è¯¯å¤„ç†

```python
@schedule('interval', minutes=10)
async def scheduled_cleanup(self, bot=None):
    """å®šæ—¶æ¸…ç†è¿‡æœŸçš„æ•°æ®"""
    try:
        # æ¸…ç†è¿‡æœŸæ•°æ®
        self._cleanup_expired_data()
        logger.info("å®šæ—¶æ¸…ç†å®Œæˆ")
    except Exception as e:
        logger.error(f"å®šæ—¶æ¸…ç†ä»»åŠ¡å¼‚å¸¸: {str(e)}")
        logger.error(traceback.format_exc())
```

### 16.4 ä¸DOWæ¡†æ¶çš„åŒºåˆ«

DOWæ¡†æ¶ä¸­ï¼Œå®šæ—¶ä»»åŠ¡é€šå¸¸æ˜¯é€šè¿‡ç›´æ¥è°ƒç”¨è°ƒåº¦å™¨çš„æ–¹æ³•æ¥æ³¨å†Œçš„ï¼š

```python
# DOWæ¡†æ¶ä¸­çš„å®šæ—¶ä»»åŠ¡æ³¨å†Œï¼ˆä¸è¦åœ¨XXXBOTä¸­ä½¿ç”¨è¿™ç§æ–¹å¼ï¼‰
scheduler.add_job(self.task_function, 'interval', minutes=5, id='task_id')
```

è€Œåœ¨XXXBOTæ¡†æ¶ä¸­ï¼Œåº”è¯¥ä½¿ç”¨è£…é¥°å™¨æ–¹å¼ï¼š

```python
# XXXBOTæ¡†æ¶ä¸­çš„å®šæ—¶ä»»åŠ¡æ³¨å†Œï¼ˆæ¨èæ–¹å¼ï¼‰
@schedule('interval', minutes=5)
async def task_function(self, bot=None):
    # ä»»åŠ¡å®ç°
    pass
```

### 16.5 æœ€ä½³å®è·µ

1. **ä½¿ç”¨è£…é¥°å™¨**ï¼šå§‹ç»ˆä½¿ç”¨`@schedule`è£…é¥°å™¨æ³¨å†Œå®šæ—¶ä»»åŠ¡ï¼Œè€Œä¸æ˜¯ç›´æ¥è°ƒç”¨åº•å±‚çš„`add_job_safe`å‡½æ•°ã€‚

2. **é”™è¯¯å¤„ç†**ï¼šåœ¨å®šæ—¶ä»»åŠ¡ä¸­å®ç°å®Œå–„çš„é”™è¯¯å¤„ç†ï¼Œé¿å…å› ä¸ºå¼‚å¸¸å¯¼è‡´å®šæ—¶ä»»åŠ¡ä¸­æ–­ã€‚
   ```python
   try:
       # å®šæ—¶ä»»åŠ¡é€»è¾‘
   except Exception as e:
       logger.error(f"å®šæ—¶ä»»åŠ¡å¼‚å¸¸: {str(e)}")
       logger.error(traceback.format_exc())
   ```

3. **æ—¥å¿—è®°å½•**ï¼šè®°å½•å®šæ—¶ä»»åŠ¡çš„æ‰§è¡Œæƒ…å†µï¼Œä¾¿äºè°ƒè¯•å’Œç›‘æ§ã€‚
   ```python
   logger.info("å¼€å§‹æ‰§è¡Œå®šæ—¶ä»»åŠ¡")
   # ä»»åŠ¡é€»è¾‘
   logger.info("å®šæ—¶ä»»åŠ¡æ‰§è¡Œå®Œæˆ")
   ```

4. **èµ„æºæ¸…ç†**ï¼šå®šæ—¶ä»»åŠ¡é€šå¸¸ç”¨äºæ¸…ç†ä¸´æ—¶æ–‡ä»¶ã€ç¼“å­˜ç­‰èµ„æºï¼Œç¡®ä¿æ¸…ç†é€»è¾‘æ­£ç¡®å®ç°ã€‚
   ```python
   @schedule('interval', hours=1)
   async def cleanup_temp_files(self, bot=None):
       """æ¸…ç†ä¸´æ—¶æ–‡ä»¶"""
       try:
           # è·å–å½“å‰æ—¶é—´
           current_time = time.time()
           # è·å–ä¸´æ—¶ç›®å½•ä¸­çš„æ‰€æœ‰æ–‡ä»¶
           for file_name in os.listdir(self.temp_dir):
               file_path = os.path.join(self.temp_dir, file_name)
               # æ£€æŸ¥æ˜¯å¦æ˜¯æ–‡ä»¶
               if os.path.isfile(file_path):
                   # è·å–æ–‡ä»¶çš„ä¿®æ”¹æ—¶é—´
                   file_mod_time = os.path.getmtime(file_path)
                   # å¦‚æœæ–‡ä»¶è¶…è¿‡24å°æ—¶æœªä¿®æ”¹ï¼Œåˆ™åˆ é™¤
                   if current_time - file_mod_time > 24 * 3600:
                       os.remove(file_path)
                       logger.info(f"å·²åˆ é™¤è¿‡æœŸä¸´æ—¶æ–‡ä»¶: {file_path}")
       except Exception as e:
           logger.error(f"æ¸…ç†ä¸´æ—¶æ–‡ä»¶å¤±è´¥: {str(e)}")
   ```

5. **é¿å…é•¿æ—¶é—´è¿è¡Œ**ï¼šå®šæ—¶ä»»åŠ¡åº”è¯¥å°½é‡å¿«é€Ÿå®Œæˆï¼Œé¿å…é•¿æ—¶é—´è¿è¡Œé˜»å¡å…¶ä»–ä»»åŠ¡ã€‚

### 16.6 ç¤ºä¾‹ï¼šå®Œæ•´çš„å®šæ—¶ä»»åŠ¡å®ç°

ä»¥ä¸‹æ˜¯ä¸€ä¸ªå®Œæ•´çš„å®šæ—¶ä»»åŠ¡å®ç°ç¤ºä¾‹ï¼ŒåŒ…æ‹¬é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•ï¼š

```python
from utils.decorators import schedule
import time
import os
import traceback
from loguru import logger

class MyPlugin(PluginBase):
    def __init__(self):
        super().__init__()
        # åˆå§‹åŒ–ä¸´æ—¶ç›®å½•
        self.temp_dir = os.path.join(os.path.dirname(__file__), "temp")
        os.makedirs(self.temp_dir, exist_ok=True)

        # åˆå§‹åŒ–ç¼“å­˜
        self.cache = {}
        self.cache_timeout = 3600  # ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰

        logger.info("æ’ä»¶åˆå§‹åŒ–å®Œæˆï¼Œå®šæ—¶ä»»åŠ¡å°†é€šè¿‡è£…é¥°å™¨è‡ªåŠ¨æ³¨å†Œ")

    @schedule('interval', minutes=30)
    async def scheduled_cleanup(self, bot=None):
        """å®šæ—¶æ¸…ç†è¿‡æœŸçš„ç¼“å­˜å’Œä¸´æ—¶æ–‡ä»¶"""
        try:
            logger.info("å¼€å§‹æ‰§è¡Œå®šæ—¶æ¸…ç†ä»»åŠ¡")

            # æ¸…ç†è¿‡æœŸç¼“å­˜
            self._cleanup_expired_cache()

            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            self._cleanup_temp_files()

            logger.info("å®šæ—¶æ¸…ç†ä»»åŠ¡æ‰§è¡Œå®Œæˆ")
        except Exception as e:
            logger.error(f"å®šæ—¶æ¸…ç†ä»»åŠ¡å¼‚å¸¸: {str(e)}")
            logger.error(traceback.format_exc())

    def _cleanup_expired_cache(self):
        """æ¸…ç†è¿‡æœŸçš„ç¼“å­˜"""
        try:
            current_time = time.time()
            expired_keys = []

            # æŸ¥æ‰¾è¿‡æœŸçš„ç¼“å­˜é¡¹
            for key, cache_item in self.cache.items():
                if current_time - cache_item["timestamp"] > self.cache_timeout:
                    expired_keys.append(key)

            # åˆ é™¤è¿‡æœŸçš„ç¼“å­˜é¡¹
            for key in expired_keys:
                del self.cache[key]

            logger.info(f"å·²æ¸…ç† {len(expired_keys)} ä¸ªè¿‡æœŸç¼“å­˜é¡¹")
        except Exception as e:
            logger.error(f"æ¸…ç†ç¼“å­˜å¼‚å¸¸: {str(e)}")

    def _cleanup_temp_files(self):
        """æ¸…ç†ä¸´æ—¶æ–‡ä»¶"""
        try:
            current_time = time.time()
            removed_count = 0

            # è·å–ä¸´æ—¶ç›®å½•ä¸­çš„æ‰€æœ‰æ–‡ä»¶
            for file_name in os.listdir(self.temp_dir):
                file_path = os.path.join(self.temp_dir, file_name)

                # æ£€æŸ¥æ˜¯å¦æ˜¯æ–‡ä»¶
                if os.path.isfile(file_path):
                    # è·å–æ–‡ä»¶çš„ä¿®æ”¹æ—¶é—´
                    file_mod_time = os.path.getmtime(file_path)

                    # å¦‚æœæ–‡ä»¶è¶…è¿‡24å°æ—¶æœªä¿®æ”¹ï¼Œåˆ™åˆ é™¤
                    if current_time - file_mod_time > 24 * 3600:
                        try:
                            os.remove(file_path)
                            removed_count += 1
                        except Exception as e:
                            logger.error(f"åˆ é™¤ä¸´æ—¶æ–‡ä»¶å¤±è´¥: {file_path}, é”™è¯¯: {str(e)}")

            logger.info(f"å·²åˆ é™¤ {removed_count} ä¸ªè¿‡æœŸä¸´æ—¶æ–‡ä»¶")
        except Exception as e:
            logger.error(f"æ¸…ç†ä¸´æ—¶æ–‡ä»¶å¼‚å¸¸: {str(e)}")
```

## 17. Bot å¯¹è±¡ç±»å‹å¤„ç†

åœ¨ XXXBOT æ¡†æ¶ä¸­ï¼Œæ’ä»¶å¯èƒ½ä¼šæ”¶åˆ°ä¸åŒç±»å‹çš„ bot å¯¹è±¡ï¼Œä¸»è¦æœ‰ä¸¤ç§ç±»å‹ï¼š
1. `WechatAPIClient` - ç›´æ¥æä¾›å¾®ä¿¡ API æ¥å£çš„å®¢æˆ·ç«¯å¯¹è±¡
2. `XYBot` - æ¡†æ¶çš„ä¸»è¦ bot å¯¹è±¡ï¼Œå†…éƒ¨åŒ…å«ä¸€ä¸ª `bot` å±æ€§ï¼Œè¯¥å±æ€§æ˜¯ `WechatAPIClient` ç±»å‹

è¿™ç§è®¾è®¡å¯èƒ½å¯¼è‡´åœ¨æŸäº›åœºæ™¯ä¸‹å‡ºç°ç±»å‹ä¸åŒ¹é…çš„é—®é¢˜ï¼Œç‰¹åˆ«æ˜¯åœ¨ä»¥ä¸‹æƒ…å†µï¼š
1. æ’ä»¶æœŸæœ›æ¥æ”¶ `WechatAPIClient` ç±»å‹çš„ bot å¯¹è±¡
2. ä½†å®é™…æ”¶åˆ°çš„æ˜¯ `XYBot` ç±»å‹çš„ bot å¯¹è±¡
3. æ’ä»¶å°è¯•è°ƒç”¨ `WechatAPIClient` ç‰¹æœ‰çš„æ–¹æ³•ï¼Œå¦‚ `get_nickname`ã€`send_text_message` ç­‰

### 17.1 é—®é¢˜è¡¨ç°

è¿™ç§ç±»å‹ä¸åŒ¹é…é—®é¢˜é€šå¸¸ä¼šå¯¼è‡´ä»¥ä¸‹é”™è¯¯ï¼š
```
ERROR | 'XYBot' object has no attribute 'get_nickname'
ERROR | 'XYBot' object has no attribute 'send_text_message'
ERROR | 'XYBot' object has no attribute 'send_at_message'
ERROR | 'XYBot' object has no attribute 'send_video_message'
```

è¿™äº›é”™è¯¯é€šå¸¸å‡ºç°åœ¨ä»¥ä¸‹åœºæ™¯ï¼š
1. å®šæ—¶ä»»åŠ¡ä¸­
2. æ¨¡æ‹Ÿç”¨æˆ·å‘é€æ¶ˆæ¯æ—¶
3. æ’ä»¶é—´è°ƒç”¨æ—¶

### 17.2 è§£å†³æ–¹æ¡ˆ

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¯ä»¥é‡‡ç”¨ä»¥ä¸‹ç­–ç•¥ï¼š

#### 17.2.1 åˆ›å»ºé€šç”¨çš„æ¶ˆæ¯å‘é€å‡½æ•°

```python
async def _send_message(self, bot, chat_id: str, content: str, at_list: list = None):
    """é€šç”¨çš„æ¶ˆæ¯å‘é€å‡½æ•°ï¼Œå¤„ç†ä¸åŒç±»å‹çš„ bot å¯¹è±¡"""
    is_group_chat = chat_id.endswith("@chatroom")
    try:
        if is_group_chat and at_list:
            # å¦‚æœ bot æ˜¯ WechatAPIClient ç±»å‹
            if hasattr(bot, 'send_at_message'):
                await bot.send_at_message(chat_id, content, at_list)
            # å¦‚æœ bot æ˜¯ XYBot ç±»å‹ï¼Œå®ƒæœ‰ä¸€ä¸ª bot å±æ€§æ˜¯ WechatAPIClient ç±»å‹
            elif hasattr(bot, 'bot') and hasattr(bot.bot, 'send_at_message'):
                await bot.bot.send_at_message(chat_id, content, at_list)
            else:
                # å°è¯•ä½¿ç”¨ send_text æ–¹æ³•
                if hasattr(bot, 'send_text'):
                    await bot.send_text(chat_id, content)
                elif hasattr(bot, 'bot') and hasattr(bot.bot, 'send_text'):
                    await bot.bot.send_text(chat_id, content)
                else:
                    logger.error(f"æ— æ³•å‘é€ç¾¤èŠæ¶ˆæ¯ï¼Œbot å¯¹è±¡ä¸æ”¯æŒ send_at_message æˆ– send_text æ–¹æ³•")
        else:
            # å¦‚æœ bot æ˜¯ WechatAPIClient ç±»å‹
            if hasattr(bot, 'send_text_message'):
                await bot.send_text_message(chat_id, content)
            # å¦‚æœ bot æ˜¯ XYBot ç±»å‹ï¼Œå®ƒæœ‰ä¸€ä¸ª bot å±æ€§æ˜¯ WechatAPIClient ç±»å‹
            elif hasattr(bot, 'bot') and hasattr(bot.bot, 'send_text_message'):
                await bot.bot.send_text_message(chat_id, content)
            # å°è¯•ä½¿ç”¨ send_text æ–¹æ³•
            elif hasattr(bot, 'send_text'):
                await bot.send_text(chat_id, content)
            elif hasattr(bot, 'bot') and hasattr(bot.bot, 'send_text'):
                await bot.bot.send_text(chat_id, content)
            else:
                logger.error(f"æ— æ³•å‘é€æ¶ˆæ¯ï¼Œbot å¯¹è±¡ä¸æ”¯æŒ send_text_message æˆ– send_text æ–¹æ³•")
        return True
    except Exception as e:
        logger.error(f"å‘é€æ¶ˆæ¯å¤±è´¥: {e}")
        return False
```

#### 17.2.2 åˆ›å»ºé€šç”¨çš„è·å–æ˜µç§°å‡½æ•°

```python
async def _get_nickname(self, bot, wxid: str) -> str:
    """é€šç”¨çš„è·å–æ˜µç§°å‡½æ•°ï¼Œå¤„ç†ä¸åŒç±»å‹çš„ bot å¯¹è±¡"""
    try:
        # å¦‚æœ bot æ˜¯ WechatAPIClient ç±»å‹
        if hasattr(bot, 'get_nickname'):
            nickname = await bot.get_nickname(wxid)
        # å¦‚æœ bot æ˜¯ XYBot ç±»å‹ï¼Œå®ƒæœ‰ä¸€ä¸ª bot å±æ€§æ˜¯ WechatAPIClient ç±»å‹
        elif hasattr(bot, 'bot') and hasattr(bot.bot, 'get_nickname'):
            nickname = await bot.bot.get_nickname(wxid)
        else:
            nickname = "ç”¨æˆ·"

        if not nickname:
            nickname = "ç”¨æˆ·"
        return nickname
    except Exception as e:
        logger.error(f"è·å–ç”¨æˆ· {wxid} æ˜µç§°å¤±è´¥: {e}")
        return "ç”¨æˆ·"
```

#### 17.2.3 åœ¨æ¨¡æ‹Ÿç”¨æˆ·å‘é€æ¶ˆæ¯æ—¶ä½¿ç”¨æ­£ç¡®çš„ bot å¯¹è±¡

```python
# ç¡®ä¿ä½¿ç”¨æ­£ç¡®ç±»å‹çš„ bot å¯¹è±¡
# å¦‚æœ bot æ˜¯ XYBot ç±»å‹ï¼Œä½¿ç”¨ bot.bot (WechatAPIClient ç±»å‹)
# å¦åˆ™ç›´æ¥ä½¿ç”¨ bot
actual_bot = bot.bot if hasattr(bot, 'bot') else bot

# è§¦å‘æ–‡æœ¬æ¶ˆæ¯äº‹ä»¶
await EventManager.emit("text_message", actual_bot, simulated_message)
```

### 17.3 æœ€ä½³å®è·µ

1. **æ£€æŸ¥å±æ€§è€Œéç±»å‹**ï¼šä½¿ç”¨ `hasattr()` æ£€æŸ¥å¯¹è±¡æ˜¯å¦æœ‰ç‰¹å®šæ–¹æ³•ï¼Œè€Œä¸æ˜¯æ£€æŸ¥å¯¹è±¡çš„ç±»å‹
2. **æä¾›é€šç”¨çš„è¾…åŠ©æ–¹æ³•**ï¼šåˆ›å»ºé€šç”¨çš„æ¶ˆæ¯å‘é€å’Œè·å–æ˜µç§°æ–¹æ³•ï¼Œå¤„ç†ä¸åŒç±»å‹çš„ bot å¯¹è±¡
3. **ä½¿ç”¨æ­£ç¡®çš„ bot å¯¹è±¡**ï¼šåœ¨æ¨¡æ‹Ÿç”¨æˆ·å‘é€æ¶ˆæ¯æ—¶ï¼Œç¡®ä¿ä½¿ç”¨æ­£ç¡®ç±»å‹çš„ bot å¯¹è±¡
4. **æ·»åŠ è¯¦ç»†çš„é”™è¯¯æ—¥å¿—**ï¼šè®°å½•è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯ï¼Œä¾¿äºè°ƒè¯•
5. **æä¾›å›é€€ç­–ç•¥**ï¼šå½“ä¸»è¦æ–¹æ³•å¤±è´¥æ—¶ï¼Œå°è¯•ä½¿ç”¨å¤‡é€‰æ–¹æ³•

### 17.4 ç¤ºä¾‹ï¼šå®Œæ•´çš„ bot å¯¹è±¡å¤„ç†

ä»¥ä¸‹æ˜¯ä¸€ä¸ªå®Œæ•´çš„ç¤ºä¾‹ï¼Œå±•ç¤ºå¦‚ä½•å¤„ç†ä¸åŒç±»å‹çš„ bot å¯¹è±¡ï¼š

```python
class MyPlugin(PluginBase):
    # ... å…¶ä»–ä»£ç  ...

    async def handle_message(self, bot, message):
        """å¤„ç†æ¶ˆæ¯"""
        try:
            # è·å–æ¶ˆæ¯å†…å®¹
            content = message["Content"]
            from_wxid = message["FromWxid"]
            sender_wxid = message["SenderWxid"]

            # è·å–ç”¨æˆ·æ˜µç§°
            nickname = await self._get_nickname(bot, sender_wxid)

            # å¤„ç†æ¶ˆæ¯
            response = f"ä½ å¥½ï¼Œ{nickname}ï¼æ”¶åˆ°ä½ çš„æ¶ˆæ¯ï¼š{content}"

            # å‘é€å›å¤
            await self._send_message(bot, from_wxid, response)
        except Exception as e:
            logger.error(f"å¤„ç†æ¶ˆæ¯å¤±è´¥: {e}")

    async def _send_message(self, bot, chat_id, content, at_list=None):
        """é€šç”¨çš„æ¶ˆæ¯å‘é€å‡½æ•°"""
        # ... å¦‚ä¸Šé¢çš„å®ç° ...

    async def _get_nickname(self, bot, wxid):
        """é€šç”¨çš„è·å–æ˜µç§°å‡½æ•°"""
        # ... å¦‚ä¸Šé¢çš„å®ç° ...
```

## 18. æ€»ç»“

åœ¨è¿ç§»DOWæ’ä»¶åˆ°XXXPADæ—¶ï¼Œéœ€è¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š

1. ä¿æŒä¸åŸç‰ˆæ’ä»¶ç›¸åŒçš„åŠŸèƒ½å’Œè¡Œä¸º
2. ç»Ÿä¸€è¡¨æƒ…ç¬¦å·å’Œæ ¼å¼
3. å¦¥å–„å¤„ç†é”™è¯¯å’Œé»˜è®¤å€¼
4. ä½¿ç”¨å¼‚æ­¥HTTPå®¢æˆ·ç«¯ä¸‹è½½åª’ä½“å†…å®¹
5. è®¾ç½®é€‚å½“çš„HTTPè¯·æ±‚å¤´ï¼Œå¤„ç†åçˆ¬æœºåˆ¶
6. å¯¹äºè§†é¢‘ï¼Œå°½å¯èƒ½æå–å¹¶æ·»åŠ å°é¢
7. å®ç°å®Œå–„çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
8. é€‰æ‹©æ­£ç¡®çš„æ¥æ”¶è€…IDå‘é€æ¶ˆæ¯ï¼Œä¼˜å…ˆä½¿ç”¨from_wxid
9. ä½¿ç”¨è£…é¥°å™¨æ–¹å¼å®ç°å®šæ—¶ä»»åŠ¡ï¼Œè€Œä¸æ˜¯ç›´æ¥è°ƒç”¨åº•å±‚å‡½æ•°
10. å¤„ç†ä¸åŒç±»å‹çš„ bot å¯¹è±¡ï¼Œåˆ›å»ºé€šç”¨çš„è¾…åŠ©æ–¹æ³•

éµå¾ªè¿™äº›æœ€ä½³å®è·µï¼Œå¯ä»¥ç¡®ä¿æ’ä»¶è¿ç§»çš„é¡ºåˆ©è¿›è¡Œï¼Œå¹¶æä¾›è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒã€‚

---

*æœ€åæ›´æ–°ï¼š2025-05-13*
